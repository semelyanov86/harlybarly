<?php

chdir(dirname(__FILE__) . "/../../..");
set_include_path(dirname(__FILE__) . "/../../..");
require_once "config.inc.php";
require_once "include/utils/utils.php";
require_once "includes/Loader.php";
vimport("includes.runtime.EntryPoint");
require_once "modules/Users/Users.php";
include "modules/QuotingTool/QuotingTool.php";
global $adb;
global $current_user;
global $site_URL;
global $document_root;
global $vtiger_current_version;
$adb = PearDatabase::getInstance();
$current_user = new Users();
$activeAdmin = $current_user->getActiveAdminUser();
$current_user->retrieve_entity_info($activeAdmin->id, "Users");
$moduleName = "QuotingTool";
if (version_compare($vtiger_current_version, "7.0.0", "<")) {
    $template_folder = "layouts/vlayout";
} else {
    $template_folder = "layouts/v7";
}
$childModule = $_REQUEST["childmodule"];
$isCreateNewRecord = $_REQUEST["iscreatenewrecord"];
$formCreateNewRecord = $_REQUEST["newrecord"];
$transactionId = $_REQUEST["record"];
$quotingTool = new QuotingTool();
$transactionRecordModel = new QuotingTool_TransactionRecord_Model();
$transactionRecord = $transactionRecordModel->findById($transactionId);
if (!$transactionRecord) {
    header("location: 404.html");
}
$dateTransaction = $transactionRecord->get("created");
$time = strtotime($dateTransaction);
$dateTransaction = date("Y-m-d", $time);
$today = date("Y-m-d");
$diff = date_diff(date_create($dateTransaction), date_create($today));
$interval = $diff->format("%d");
$expire_in_days = $transactionRecord->get("expire_in_days");
if ($expire_in_days < $interval && $expire_in_days != 0) {
    header("location: expire.html");
}
$session = isset($_REQUEST["session"]) && $_REQUEST["session"] ? $_REQUEST["session"] : "";
$hash = $transactionRecord->get("hash");
$hash = $hash ? $hash : "";
$dateFormat = $transactionRecord->get("date_format");
if ($dateFormat == "") {
    $dateFormat = $current_user->date_format;
}
if ($session != $hash) {
    header("location: 404.html");
}
if (!$_REQUEST["preview"] || $_REQUEST["preview"] != true) {
    $signedRecordModuleModel = Vtiger_Module_Model::getInstance("SignedRecord");
    $newSignedRecordId = 0;
    if ($signedRecordModuleModel) {
        $timestamp = time();
        if ($transactionRecord->get("track_open") == 1) {
            $newSignedRecord = array("signature" => $transactionRecord->get("signature"), "signature_name" => $transactionRecord->get("signature_name"), "signedrecord_type" => SignedRecord_Record_Model::TYPE_OPENED, "signature_date" => date("Y-m-d", $timestamp), "cf_signature_time" => date("H:i:s", $timestamp), "related_to" => $transactionRecord->get("record_id"), "cf_template" => $transactionRecord->get("filename"), "signedrecord_browser" => $_SERVER["HTTP_USER_AGENT"], "signedrecord_ip" => get_client_ip(), "signedrecord_cookie" => json_encode($_COOKIE), "transactionid" => $transactionId);
        } else {
            $newSignedRecord = array("signature" => $transactionRecord->get("signature"), "signature_name" => $transactionRecord->get("signature_name"), "signature_date" => date("Y-m-d", $timestamp), "cf_signature_time" => date("H:i:s", $timestamp), "related_to" => $transactionRecord->get("record_id"), "cf_template" => $transactionRecord->get("filename"), "transactionid" => $transactionId);
        }
        if ($transactionRecord->get("record_id") != 0) {
            $parentRecordModel = Vtiger_Record_Model::getInstanceById($transactionRecord->get("record_id"));
            $parentAssignedTo = $parentRecordModel->get("assigned_user_id");
            $newSignedRecord["assigned_user_id"] = $parentAssignedTo;
        }
        if (!empty($transactionId)) {
            $sql = "SELECT signedrecordid FROM vtiger_signedrecordcf WHERE transactionid=? LIMIT 0, 1";
            $rs = $adb->pquery($sql, array($transactionId));
            if (0 < $adb->num_rows($rs)) {
                $newSignedRecordId = $adb->query_result($rs, 0, "signedrecordid");
            }
        }
        if ($newSignedRecordId) {
            $signedRecordModel = Vtiger_Record_Model::getInstanceById($newSignedRecordId);
            $signedRecordModel->set("id", $newSignedRecordId);
            $signedRecordModel->set("mode", "edit");
        } else {
            $signedRecordModel = Vtiger_Record_Model::getCleanInstance("SignedRecord");
        }
        foreach ($newSignedRecord as $field => $value) {
            $signedRecordModel->set($field, $value);
        }
        $signedRecordModel->save();
        if ($transactionRecord->get("record_id") != 0) {
            $newSignedRecordId = $signedRecordModel->getId();
            $parentModuleModel = Vtiger_Record_Model::getInstanceById($transactionRecord->get("record_id"));
            $parentModuleName = $parentModuleModel->getModuleName();
            $parentModuleModel = Vtiger_Module_Model::getInstance($parentModuleName);
            $relModuleModel = Vtiger_Module_Model::getInstance("SignedRecord");
            $relationModel = Vtiger_Relation_Model::getInstance($parentModuleModel, $relModuleModel);
            if ($relationModel) {
                $relationModel->addRelation($transactionRecord->get("record_id"), $signedRecordModel->getId());
            }
        }
    }
}
$signTo = $transactionRecord->get("sign_to");
$tranStatus = $transactionRecord->get("status");
$tranStatusText = "";
if ($tranStatus == "1") {
    $tranStatusText = $transactionRecord->get("label_accept");
} else {
    if ($tranStatus == "-1") {
        $tranStatusText = $transactionRecord->get("label_decline");
    }
}
$an_payment_block = "";
if (file_exists($document_root . "modules/ANCustomers/libs/InvoiceWidget/QuotingTool.php")) {
    require_once "modules/ANCustomers/libs/InvoiceWidget/QuotingTool.php";
    $anQuotingTool = new ANQuotingTool();
    if (method_exists($anQuotingTool, "getANPaymentBlockHtml")) {
        $an_payment_block = $anQuotingTool->getANPaymentBlockHtml($transactionRecord);
    }
}
if ($an_payment_block != "") {
    $an_payment_block_base64 = base64_encode($an_payment_block);
} else {
    $an_payment_block_base64 = "";
}
$success_content = "Your information has been submitted.<br><br>You can now close this page.<br><br>Thank you";
if ($transactionRecord->get("settings_layout")) {
    $settingsLayout = json_decode(html_entity_decode($transactionRecord->get("settings_layout")));
    $settingsLayout = (array) $settingsLayout;
    $orientation = $settingsLayout["orientation"];
    $pageFormat = $settingsLayout["format"];
    $margin_top = $settingsLayout["margin_top"];
    $margin_left = $settingsLayout["margin_left"];
    $margin_bottom = $settingsLayout["margin_bottom"];
    $margin_right = $settingsLayout["margin_right"];
    $pageMargin = $margin_top . "mm " . $margin_right . "mm " . $margin_bottom . "mm " . $margin_left . "mm";
    if ($pageFormat == "Custom") {
        $pWidth = $settingsLayout["width"] * 72 / 25.4;
        $pHeight = $settingsLayout["height"] * 72 / 25.4;
    } else {
        $pageFormat = strtoupper($pageFormat);
        switch ($pageFormat) {
            case "A4":
                $pWidth = 595.28;
                $pHeight = 841.89;
                break;
            case "A3":
                $pWidth = 841.89;
                $pHeight = 1190.55;
                break;
            case "LETTER":
                $pWidth = 612;
                $pHeight = 792;
                break;
            case "LEGAL":
                $pWidth = 612;
                $pHeight = 1008;
                break;
            default:
                $pWidth = 595.28;
                $pHeight = 841.89;
                break;
        }
        if ($orientation == "L") {
            $pageWidth = $pHeight;
            $pageHeight = $pWidth;
        } else {
            $pageWidth = $pWidth;
            $pageHeight = $pHeight;
        }
        $contentWidth = $pageWidth;
        $pageWidth = $pageWidth - $margin_left * 72 / 25.4 - $margin_right * 72 / 25.4;
    }
} else {
    $margin_top = 16;
    $margin_left = 15;
    $margin_bottom = 16;
    $margin_right = 15;
    $pageMargin = $margin_top . "mm " . $margin_right . "mm " . $margin_bottom . "mm " . $margin_left . "mm";
    $pageWidth = 595.28;
    $contentWidth = $pageWidth;
    $pageWidth = $pageWidth - $margin_left * 72 / 25.4 - $margin_right * 72 / 25.4;
}
echo "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\r\n    <title>Document</title>\r\n    <meta name=\"robots\" content=\"noindex\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/signature-pad/assets/jquery.signaturepad.css\">\r\n<!--    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../libraries/bootstrap/css/bootstrap.css\">-->\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"css/bootstrap.min.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../libraries/bootstrap/css/bootstrap-responsive.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/loading-indicator-3.3.1/jquery.loading-indicator.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../libraries/jquery/timepicker/jquery.timepicker.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../libraries/bootstrap/js/eternicode-bootstrap-datepicker/css/datepicker.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../resources/styles.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../resources/web.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"css/proposal.css\">\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"css/fontproposal.php\">\r\n    <script type=\"text/javascript\" src=\"../../../libraries/jquery/jquery.min.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../libraries/jquery/jquery-ui/js/jquery-ui-1.8.16.custom.min.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../libraries/jquery/chosen/chosen.jquery.min.js\"></script>\r\n    ";
if (version_compare($vtiger_current_version, "7.0.0", "<")) {
    echo "        <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../libraries/jquery/select2/select2.css\">\r\n        <script type=\"text/javascript\" src=\"../../../libraries/jquery/select2/select2.min.js\"></script>\r\n    ";
} else {
    echo "        <script type=\"text/javascript\" src=\"../../../";
    echo $template_folder;
    echo "/lib/jquery/select2/select2.min.js\"></script>\r\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"../../../";
    echo $template_folder;
    echo "/lib/jquery/select2/select2.css\">\r\n    ";
}
echo "\r\n    <script type=\"text/javascript\" src=\"../../../libraries/jquery/timepicker/jquery.timepicker.min.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../libraries/bootstrap/js/eternicode-bootstrap-datepicker/js/bootstrap-datepicker.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/utils/jQuery-customs.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../resources/app.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/QuotingToolUtils.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/utils/helper.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../libraries/bootstrap/js/bootstrap.min.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/signature-pad/jquery.signaturepad.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/signature-pad/assets/json2.min.js\"></script>\r\n    <!--[if lt IE 9]>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/signature-pad/assets/flashcanvas.js\"></script>\r\n    <![endif]-->\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/loading-indicator-3.3.1/jquery.loading-indicator.min.js\"></script>\r\n    <script type=\"text/javascript\" src=\"../../../";
echo $template_folder;
echo "/modules/";
echo $moduleName;
echo "/resources/js/libs/signature-pad/html2canvas.min.js\"></script>\r\n</head>\r\n<body>\r\n<div id=\"check_dpi\" style=\"height: 1in;width: 1in;position: absolute;left: -100%;top: -100%;\"></div>\r\n<div id=\"quoting_tool-app\">\r\n    <input type=\"hidden\" id=\"row_type\" value=\"medium\">\r\n    <input type=\"hidden\" id=\"date_format\" value=\"";
echo $dateFormat;
echo "\">\r\n    <input type=\"hidden\" id=\"hour_format\" value=\"";
echo $current_user->hour_format;
echo "\">\r\n    <input type=\"hidden\" id=\"start_hour\" value=\"";
echo $current_user->start_hour;
echo "\">\r\n    <input type=\"hidden\" id=\"end_hour\" value=\"";
echo $current_user->end_hour;
echo "\">\r\n    <input type=\"hidden\" id=\"time_zone\" value=\"";
echo $current_user->time_zone;
echo "\">\r\n    <input type=\"hidden\" id=\"dayoftheweek\" value=\"";
echo $current_user->dayoftheweek;
echo "\">\r\n    <input type=\"hidden\" id=\"page_width\" value=\"";
if ($pageWidth) {
    echo $pageWidth;
}
echo "\">\r\n    <input type=\"hidden\" id=\"page_margin\" value=\"";
if ($pageMargin) {
    echo $pageMargin;
}
echo "\">\r\n    <input type=\"hidden\" id=\"content_width\" value=\"";
if ($contentWidth) {
    echo $contentWidth;
}
echo "\">\r\n    <input type=\"hidden\" name=\"signature_image_index\" value=\"\"/>\r\n    <div id=\"viewport\">\r\n        <div id=\"quoting_tool-body\" style=\"position: relative\">\r\n            <form action=\"action.php\" name=\"frm-proposal-content\" method=\"post\" class=\"proposal-form-submit\">\r\n                <input type=\"hidden\" name=\"_action\" value=\"\" />\r\n                <input type=\"hidden\" name=\"ajxaction\" value=\"DETAILVIEW\" /><!--Prevent saveInventoryProductDetails-->\r\n                <input type=\"hidden\" name=\"module\" value=\"";
echo $transactionRecord->get("module");
echo "\" />\r\n                <input type=\"hidden\" name=\"record\" value=\"";
echo $transactionId;
echo "\" />\r\n                <input type=\"hidden\" name=\"record_id\" value=\"";
echo $transactionRecord->get("record_id");
echo "\" />\r\n                <input type=\"hidden\" name=\"name\" value=\"";
echo $transactionRecord->get("filename");
echo "\" />\r\n                <textarea name=\"header\" class=\"hide\">";
echo $transactionRecord->get("header");
echo "</textarea>\r\n                <textarea name=\"content\" class=\"hide\">";
echo $transactionRecord->get("full_content");
echo "</textarea>\r\n                <textarea name=\"an_payment_block\" class=\"hide\">";
echo $an_payment_block_base64;
echo "</textarea>\r\n                <textarea name=\"footer\" class=\"hide\">";
echo $transactionRecord->get("footer");
echo "</textarea>\r\n                <textarea name=\"signature\" class=\"hide\">";
echo $transactionRecord->get("signature");
echo "</textarea>\r\n                <textarea name=\"secondary_signature\" class=\"hide\">";
echo $transactionRecord->get("secondary_signature");
echo "</textarea>\r\n                <input type=\"hidden\" name=\"signature_name\" value=\"";
echo $transactionRecord->get("signature_name");
echo "\" />\r\n                <input type=\"hidden\" name=\"initials_primary\" value=\"";
echo $transactionRecord->get("initials_primary");
echo "\" />\r\n                <input type=\"hidden\" name=\"secondary_signature_name\" value=\"";
echo $transactionRecord->get("secondary_signature_name");
echo "\" />\r\n                <input type=\"hidden\" name=\"initials_secondary\" value=\"";
echo $transactionRecord->get("initials_secondary");
echo "\" />\r\n\r\n                <input type=\"hidden\" name=\"title_signature_primary\" value=\"";
echo $transactionRecord->get("title_signature_primary");
echo "\" />\r\n                <input type=\"hidden\" name=\"title_signature_secondary\" value=\"";
echo $transactionRecord->get("title_signature_secondary");
echo "\" />\r\n                <input type=\"hidden\" name=\"is_draw_signature\" value=\"";
echo $transactionRecord->get("is_draw_signature");
echo "\" />\r\n\r\n                <input type=\"hidden\" name=\"signature_datetime\" value=\"";
echo $transactionRecord->get("updated");
echo "\" />\r\n                <input type=\"hidden\" name=\"secondary_signature_datetime\" value=\"";
echo $transactionRecord->get("secondary_updated");
echo "\" />\r\n                <input type=\"hidden\" name=\"status\" value=\"";
echo $transactionRecord->get("status");
echo "\" />\r\n                <input type=\"hidden\" name=\"secondary_status\" value=\"";
echo $transactionRecord->get("secondary_status");
echo "\" />\r\n                <input type=\"hidden\" name=\"status_text\" value=\"";
echo $tranStatusText;
echo "\" />\r\n                <input type=\"hidden\" name=\"is_create_new_record\" value=\"";
echo $isCreateNewRecord;
echo "\" />\r\n                <input type=\"hidden\" name=\"form_create_record\" value=\"";
echo $formCreateNewRecord;
echo "\" />\r\n                <input type=\"hidden\" name=\"child_module\" value=\"";
echo $childModule;
echo "\" />\r\n                <textarea name=\"description_transaction\" class=\"hide\">";
echo $transactionRecord->get("description");
echo "</textarea>\r\n                <textarea name=\"background\" class=\"hide\">";
echo $transactionRecord->get("background");
echo "</textarea>\r\n                <textarea name=\"attachments\" class=\"hide\">";
echo $transactionRecord->get("attachments");
echo "</textarea>\r\n                <textarea name=\"custom_mapping_fields\" class=\"hide\"></textarea>\r\n                <textarea name=\"customer_comment\" class=\"hide\"></textarea>\r\n                <input type=\"hidden\" name=\"signedrecord_id\" value=\"";
echo $newSignedRecordId;
echo "\" />\r\n                <input type=\"hidden\" id=\"hfSignTo\" name=\"sign_to\" value=\"";
echo $signTo;
echo "\">\r\n                <input type=\"hidden\" id=\"enable_decline_mess\" name=\"enable_decline_mess\" value=\"";
echo $transactionRecord->get("enable_decline_mess");
echo "\">\r\n\r\n                <div id=\"content\">\r\n                    <!--<div class=\"actions\"></div>-->\r\n                    <div class=\"document\" id=\"web-view-document\"></div>\r\n                    <div id=\"dummy\" style=\"visibility: hidden; display: inline-block;\"></div>\r\n                </div>\r\n                ";
if ($_REQUEST["preview"] == "true") {
    echo "                <div id=\"sidebar\">\r\n                    <div class=\"contents actions\">\r\n                        <div id=\"pdf-action-accept\" class=\"pdf-actions\">\r\n                            <a href=\"javascript:;\">\r\n                                <div class=\"action action-accept inactive\">\r\n                                <span class=\"btn btn-success proposal-btn\">\r\n                                    <i title=\"Accept\" class=\"icon-ok pull-left\"></i>\r\n                                    ";
    echo $transactionRecord->get("label_accept");
    echo "                                </span>\r\n                                </div>\r\n                            </a>\r\n                        </div>\r\n                        ";
    if ($transactionRecord->get("label_decline") != "") {
        echo "                            <div id=\"pdf-action-decline\" class=\"pdf-actions\">\r\n                                <a href=\"javascript:;\">\r\n                                    <div class=\"action action-decline inactive\">\r\n                                <span class=\"btn btn-danger proposal-btn\">\r\n                                    <i title=\"Decline\" class=\"icon-ok pull-left\"></i>\r\n                                    ";
        echo $transactionRecord->get("label_decline");
        echo "                                </span>\r\n                                    </div>\r\n                                </a>\r\n                            </div>\r\n                        ";
    }
    echo "                    </div>\r\n\r\n                    <div id=\"quoting_tool-sidebar-content\" class=\"contents\">\r\n                        <dl>\r\n                            <dd>\r\n                                <a href=\"#quoting_tool-sidebar-hashtag\"\r\n                                   data-toggle=\"collapse\" aria-expanded=\"false\" aria-controls=\"quoting_tool-sidebar-hashtag\">\r\n                                    <strong class=\"proposal-doc-name\">";
    echo $transactionRecord->get("filename");
    echo "</strong>\r\n                                    <i class=\"indicator icon-chevron-down pull-right\"></i>\r\n                                </a>\r\n                            </dd>\r\n                        </dl>\r\n                        <ul id=\"quoting_tool-sidebar-hashtag\" class=\"quoting_tool-sidebar collapse in\">\r\n                            <li class=\"selected\">\r\n                                <a href=\"#\">Proposal Summary &amp; Scope</a>\r\n                            </li>\r\n                        </ul>\r\n\r\n                        <div id=\"pdf-download\" class=\"pdf-actions\">\r\n                            <a class=\"pdf-download-link\"\r\n                               href=\"javascript:;\">\r\n                                <span>Download PDF</span>\r\n                            </a>\r\n                        </div>\r\n\r\n                        <div id=\"pdf-sign\" class=\"pdf-actions\">\r\n<!--                            <a class=\"pdf-download-link\" data-toggle=\"modal\" data-target=\"#myModal\" href=\"#\">-->\r\n                            <a class=\"pdf-download-link\" data-target=\"#myModal\" href=\"javascript:void(0);\">\r\n                                <span>Signature</span>\r\n                            </a>\r\n                        </div>\r\n                    </div>\r\n\r\n                    ";
    if ($transactionRecord->get("description")) {
        echo "                        <div class=\"contents quoting_tool-description\">\r\n                            <dl>\r\n                                <dd>\r\n                                    <!--<a href=\"#quoting_tool-description-content\" data-toggle=\"collapse\" aria-expanded=\"false\"\r\n                                       aria-controls=\"quoting_tool-description-content\">-->\r\n                                    <a href=\"javascript:void(0);\">\r\n                                        <strong class=\"proposal-doc-name\">Notes</strong>\r\n                                        <!--<i class=\"indicator icon-chevron-down pull-right\"></i>-->\r\n                                    </a>\r\n                                </dd>\r\n                            </dl>\r\n                            <ul id=\"quoting_tool-description-content\" class=\"quoting_tool-sidebar collapse in\">\r\n                                <li class=\"selected\">\r\n                                    ";
        echo $transactionRecord->get("description") ? nl2br($transactionRecord->get("description")) : "";
        echo "                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    ";
    }
    echo "\r\n                    ";
    if ($transactionRecord->get("attachments")) {
        echo "                        <div class=\"contents quoting_tool-attachments\">\r\n                            <dl>\r\n                                <dd>\r\n                                    <a href=\"#quoting_tool-sidebar-attachment\"\r\n                                       data-toggle=\"collapse\" aria-expanded=\"false\" aria-controls=\"quoting_tool-sidebar-attachment\">\r\n                                        <strong class=\"proposal-doc-name\">Attachments</strong>\r\n                                        <i class=\"indicator icon-chevron-down pull-right\"></i>\r\n                                    </a>\r\n                                </dd>\r\n                            </dl>\r\n                            <ul id=\"quoting_tool-sidebar-attachment\" class=\"quoting_tool-sidebar collapse in\">\r\n                            </ul>\r\n                        </div>\r\n                    ";
    }
    echo "\r\n                    <!--Paid Area start-->\r\n                    ";
    $enable_an_pay_online = true;
    $template_id = $transactionRecord->get("template_id");
    $resultPay = $adb->pquery("SELECT anwidget FROM vtiger_quotingtool WHERE `id` = ? LIMIT 1", array($template_id));
    if ($adb->num_rows($resultPay)) {
        $an_widget = $adb->query_result($resultPay, 0, "anwidget");
        if ($an_widget != 1) {
            $enable_an_pay_online = false;
        }
    } else {
        $enable_an_pay_online = false;
    }
    if (!file_exists($document_root . "modules/ANCustomers/libs/InvoiceWidget/QuotingTool.php")) {
        $enable_an_pay_online = false;
    }
    if ($enable_an_pay_online) {
        require_once "modules/ANCustomers/libs/InvoiceWidget/QuotingTool.php";
        $currentYear = (int) date("Y");
        $anQuotingTool = new ANQuotingTool();
        $anActive = $anQuotingTool->isANEnable();
        if ($anActive) {
            $anInfo = $anQuotingTool->getANInvoiceInfo($transactionRecord->get("record_id"));
            if (!empty($anInfo) && $anInfo["accountid"]) {
                $payments = $anQuotingTool->getPaymentRecords($transactionRecord->get("record_id"), "*%", "", "amount_paid", "*Failed");
                $al_payments_not_paid = $anQuotingTool->getPaymentRecords($transactionRecord->get("record_id"), "*%", "", "", "*Failed");
                $count_payment = count($payments);
                $count_of_al_payment_not_paid = count($al_payments_not_paid);
                $full_amount = 0;
                $full_amount_value = "sum";
                if ($count_of_al_payment_not_paid == 0) {
                    $full_amount = $anInfo["balance"];
                    $full_amount_value = "full";
                } else {
                    $full_amount = $anInfo["balance"];
                    $full_amount_value = "full";
                }
                if (0 < $full_amount) {
                    $full_amount = number_format($full_amount, 2);
                }
                echo "                                <script type=\"text/javascript\">\r\n                                    \$( function() {\r\n                                        \$('#an-paid-form input[name=an_payment_method]').on('click', function(){\r\n                                            \$('#an-paid-form #CreditCardSimpleType').hide();\r\n                                            \$('#an-paid-form #BankAccountType').hide();\r\n                                            \$('#an-paid-form #'+\$(this).val()).slideDown('slow');\r\n                                        });\r\n\r\n                                        //show echeck type depend on bank account type\r\n                                        var anForm = \$('#an-paid-form');\r\n                                        \$('#an_account_type', anForm).on('change', function (event) {\r\n                                            event.preventDefault();\r\n                                            var element = \$(this);\r\n                                            var bank_account_type = element.val();\r\n                                            if(bank_account_type==''){\r\n                                                \$('#an_e_check_type option', anForm).each(function(){\r\n                                                    if(\$(this).val()!==''){\r\n                                                        \$(this).attr('disabled', true);\r\n                                                    }\r\n                                                    \$(this).removeAttr('selected');\r\n                                                });\r\n                                                \$('#an_e_check_type', anForm).val('');\r\n                                            }else if(bank_account_type=='businessChecking'){\r\n                                                \$('#an_e_check_type option', anForm).each(function(){\r\n                                                    if(\$(this).val()!=='CCD'){\r\n                                                        \$(this).attr('disabled', true);\r\n                                                        \$(this).removeAttr('selected');\r\n                                                    }else{\r\n                                                        \$(this).removeAttr('disabled');\r\n                                                    }\r\n                                                });\r\n                                                \$('#an_e_check_type', anForm).val('CCD');\r\n                                            }else{\r\n                                                \$('#an_e_check_type option', anForm).each(function(){\r\n                                                    if(\$(this).val()=='CCD'){\r\n                                                        \$(this).attr('disabled', true);\r\n                                                        \$(this).removeAttr('selected');\r\n                                                    }else{\r\n                                                        \$(this).removeAttr('disabled');\r\n                                                    }\r\n                                                });\r\n                                                \$('#an_e_check_type', anForm).val('');\r\n                                            }\r\n                                        });\r\n                                        \$('#an_account_type', anForm).trigger('change');\r\n\r\n                                        //hanlde other amount\r\n                                        \$('#an_amount', anForm).on('change', function (event) {\r\n                                            event.preventDefault();\r\n                                            var amount = \$(this).val();\r\n                                            if(amount=='other'){\r\n                                                \$('#other_amount', anForm).removeClass('hide');\r\n                                            }else{\r\n                                                \$('#other_amount', anForm).addClass('hide');\r\n                                            }\r\n                                        });\r\n\r\n                                        \$('#other_amount', anForm).on('change', function (event) {\r\n                                            event.preventDefault();\r\n                                            var other_amount = \$(this).val();\r\n                                            if(other_amount==''){\r\n                                                other_amount = 0;\r\n                                            }\r\n                                            other_amount = parseFloat(other_amount);\r\n                                            var full_amount = \$('#invoice_balance', anForm).val();\r\n                                            if(full_amount==''){\r\n                                                full_amount = 0;\r\n                                            }\r\n                                            full_amount = parseFloat(full_amount);\r\n                                            if(other_amount > full_amount){\r\n                                                alert('Other Amount should be smaller than or equal to Full Amount!');\r\n                                                \$('#other_amount', anForm).val(full_amount.toFixed(2));\r\n                                            }\r\n                                        });\r\n\r\n                                        //submit form\r\n                                        \$('#an-paid-form #an-paid-btn').on('click', function(event){\r\n                                            var element = \$(this);\r\n                                            element.attr('disabled', true);\r\n                                            event.preventDefault();\r\n                                            var container = element.closest('#an-paid-form');\r\n                                            var method = container.find('input[name=an_payment_method]:checked').val();\r\n                                            var is_valid = true;\r\n                                            container.find('#'+method+' input').each(function(){\r\n                                                if(\$.trim(\$(this).val())==''){\r\n                                                    is_valid = false;\r\n                                                }\r\n                                            });\r\n                                            container.find('#'+method+' select').each(function(){\r\n                                                if(\$.trim(\$(this).val())==''){\r\n                                                    is_valid = false;\r\n                                                }\r\n                                            });\r\n\r\n                                            var other_amount = \$('#other_amount', anForm).val();\r\n                                            if(other_amount==''){\r\n                                                other_amount = 0;\r\n                                            }\r\n                                            var full_amount = \$('#invoice_balance', anForm).val();\r\n                                            if(full_amount==''){\r\n                                                full_amount = 0;\r\n                                            }\r\n                                            if(parseFloat(other_amount) > parseFloat(full_amount)){\r\n                                                alert('Other Amount should be smaller than or equal to Full Amount!');\r\n                                                is_valid = false;\r\n                                                return false;\r\n                                            }\r\n\r\n                                            if(!is_valid){\r\n                                                element.removeAttr('disabled');\r\n                                                alert('All field is required.');\r\n                                                return false;\r\n                                            }else{\r\n                                                //if fill data full then submit form\r\n                                                var params = {};\r\n                                                params['invoice_id'] = \$('#an-paid-form #an_invoice_id').val();\r\n                                                params['account_id'] = \$('#an-paid-form #an_account_id').val();\r\n                                                params['customerprofileid'] = \$('#an-paid-form #an_profileid').val();\r\n                                                params['customershippingaddressid'] = \$('#an-paid-form #an_shippingaddressid').val();\r\n                                                params['amount'] = \$('#an-paid-form #an_amount').val();\r\n                                                params['payment_method'] = method;\r\n                                                params['card_number'] = \$('#an-paid-form #an_card_number').val();\r\n                                                params['expiration_month'] = \$('#an-paid-form #an_expiration_month').val();\r\n                                                params['expiration_year'] = \$('#an-paid-form #an_expiration_year').val();\r\n                                                params['ccv'] = \$('#an-paid-form #an_ccv').val();\r\n                                                params['bank_name'] = \$('#an-paid-form #an_bank_name').val();\r\n                                                params['account_number'] = \$('#an-paid-form #an_account_number').val();\r\n                                                params['name_on_account'] = \$('#an-paid-form #an_name_on_account').val();\r\n                                                params['routing_number'] = \$('#an-paid-form #an_routing_number').val();\r\n                                                params['account_type'] = \$('#an-paid-form #an_account_type').val();\r\n                                                params['e_check_type'] = \$('#an-paid-form #an_e_check_type').val();\r\n                                                params['other_amount'] = \$('#an-paid-form #other_amount').val();\r\n                                                params['_action'] = 'an_paid';\r\n                                                \$.ajax({\r\n                                                    type: \"POST\",\r\n                                                    url: 'action.php',\r\n                                                    data: params, // serializes the form's elements.\r\n                                                    success: function(data)\r\n                                                    {\r\n                                                        alert(data.result);\r\n                                                        if(data.result.indexOf('Error:') === 0){\r\n                                                            element.removeAttr('disabled');\r\n                                                        }else{\r\n                                                            container.find('input').val('').attr('disabled', true);\r\n                                                            container.find('select').val('').attr('disabled', true);\r\n                                                        }\r\n                                                    }\r\n                                                });\r\n                                            }\r\n                                        });\r\n                                    } );\r\n                                </script>\r\n                                <style>\r\n                                    #viewport #sidebar{position: relative;}\r\n                                    .an-payment-widget{padding: 0;margin: 0 auto;}\r\n                                    .an-payment-widget #an-paid-form{padding: 0 15px 15px 15px;}\r\n                                    .an-payment-widget #paid-form h3{margin-top: 0;}\r\n                                    .an-payment-widget input, textarea, select, .uneditable-input{height: auto !important;}\r\n                                    .an-payment-widget .row-fluid > [class*=\"span\"]{margin-left: 0 !important;}\r\n                                    .an-payment-widget .field-required{color: #FF0000;}\r\n                                    .an-payment-widget .e-check{display: none;}\r\n                                    .an-payment-widget .card-icon{height: 16px;vertical-align: top;}\r\n                                    .an-payment-widget #an_e_check_type option:disabled{background-color: #cccccc;}\r\n                                </style>\r\n\r\n\r\n                                <div class=\"container-fluid an-payment-widget contents\" style=\"background-color: #FFFFFF;\">\r\n                                    <dl>\r\n                                        <dd>\r\n                                            <a href=\"#quoting_tool-sidebar-hashtag\"\r\n                                               data-toggle=\"collapse\" aria-expanded=\"false\" aria-controls=\"quoting_tool-sidebar-hashtag\">\r\n                                                <strong class=\"proposal-doc-name\">Pay Online</strong>\r\n                                                <i class=\"indicator icon-chevron-down pull-right\"></i>\r\n                                            </a>\r\n                                        </dd>\r\n                                    </dl>\r\n                                    <div id=\"an-paid-form\">\r\n                                        <input type=\"hidden\" id=\"an_invoice_id\" value=\"";
                echo $transactionRecord->get("record_id");
                echo "\" />\r\n                                        <input type=\"hidden\" id=\"an_account_id\" value=\"";
                echo $anInfo["accountid"];
                echo "\" />\r\n                                        <input type=\"hidden\" id=\"an_profileid\" value=\"";
                echo $anInfo["customerprofileid"];
                echo "\" />\r\n                                        <input type=\"hidden\" id=\"an_shippingaddressid\" value=\"";
                echo $anInfo["customershippingaddressid"];
                echo "\" />\r\n                                        <input type=\"hidden\" id=\"invoice_balance\" value=\"";
                echo $anInfo["balance"];
                echo "\" />\r\n                                        <div class=\"row-fluid\">\r\n                                            <div class=\"span12\">\r\n                                                <h3 style=\"text-align: center;\"><span>Amount</span>\r\n                                                    <select id=\"an_amount\" class=\"input-large\">\r\n                                                        <option value=\"";
                echo $full_amount_value;
                echo "\">Balance: \$";
                echo $full_amount;
                echo "</option>\r\n                                                        ";
                if (1 < $count_payment) {
                    echo "                                                            <option value=\"\" disabled>----</option>\r\n                                                            ";
                    foreach ($payments as $payment) {
                        echo "                                                                <option value=\"";
                        echo $payment["paymentid"];
                        echo "\">Partial: \$";
                        echo $payment["amount_paid_display"];
                        echo "</option>\r\n                                                            ";
                    }
                    echo "                                                            <option value=\"\" disabled>----</option>\r\n                                                        ";
                }
                echo "                                                        <option value=\"other\">Other (Type in the amount)</option>\r\n                                                    </select>\r\n                                                    <input type=\"number\" id=\"other_amount\" min=\"0\" max=\"";
                echo $full_amount;
                echo "\" value=\"\" class=\"input-large hide\" placeholder=\"Enter other amount...\" style=\"text-align: center;\"/>\r\n                                                </h3>\r\n                                            </div>\r\n                                            <div class=\"span12\">\r\n                                                <input type=\"radio\" name=\"an_payment_method\" value=\"CreditCardSimpleType\" checked />\r\n                                                <span>Credit Card</span>\r\n                                                <img src=\"";
                echo $site_URL . "/" . $template_folder;
                echo "/modules/ANCustomers/resources/img/visa_curved.png\" class=\"card-icon\" title=\"Visa\"/>\r\n                                                <img src=\"";
                echo $site_URL . "/" . $template_folder;
                echo "/modules/ANCustomers/resources/img/mastercard_curved.png\" class=\"card-icon\" title=\"Master Card\"/>\r\n                                                <img src=\"";
                echo $site_URL . "/" . $template_folder;
                echo "/modules/ANCustomers/resources/img/american_express.png\" class=\"card-icon\" title=\"American Express\"/>\r\n                                                <img src=\"";
                echo $site_URL . "/" . $template_folder;
                echo "/modules/ANCustomers/resources/img/discover_straight.png\" class=\"card-icon\" title=\"Discover\"/>\r\n                                                <img src=\"";
                echo $site_URL . "/" . $template_folder;
                echo "/modules/ANCustomers/resources/img/jcb.png\" class=\"card-icon\" title=\"JCB\"/>\r\n                                                <div class=\"credit-card row-fluid\" id=\"CreditCardSimpleType\">\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Card Number<span class=\"field-required\">*</span></label>\r\n                                                        <input type=\"number\" id=\"an_card_number\" value=\"\" class=\"input-large\"/>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Expiration MM/YY<span class=\"field-required\">*</span></label>\r\n                                                        <select class=\"input-small\" id=\"an_expiration_month\">\r\n                                                            <option value=\"\">Month</option>\r\n                                                            <option value=\"01\">01</option>\r\n                                                            <option value=\"02\">02</option>\r\n                                                            <option value=\"03\">03</option>\r\n                                                            <option value=\"04\">04</option>\r\n                                                            <option value=\"05\">05</option>\r\n                                                            <option value=\"06\">06</option>\r\n                                                            <option value=\"07\">07</option>\r\n                                                            <option value=\"08\">08</option>\r\n                                                            <option value=\"09\">09</option>\r\n                                                            <option value=\"10\">10</option>\r\n                                                            <option value=\"11\">11</option>\r\n                                                            <option value=\"12\">12</option>\r\n                                                        </select>\r\n                                                        <select class=\"input-small\" id=\"an_expiration_year\">\r\n                                                            <option value=\"\">Year</option>\r\n                                                            ";
                for ($i = 0; $i <= 10; $i++) {
                    echo "                                                                <option value=\"";
                    echo $i + $currentYear;
                    echo "\">";
                    echo $i + $currentYear;
                    echo "</option>\r\n                                                            ";
                }
                echo "                                                        </select>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>CVV<span class=\"field-required\">*</span></label>\r\n                                                        <input type=\"number\" id=\"an_ccv\" value=\"\" class=\"input-large\"/>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div class=\"span12\">\r\n                                                <input type=\"radio\" name=\"an_payment_method\" value=\"BankAccountType\" />\r\n                                                <span>e-Check</span>\r\n                                                <img src=\"";
                echo $site_URL . "/" . $template_folder;
                echo "/modules/ANCustomers/resources/img/service_echeck.png\" class=\"card-icon\" title=\"Electronic Check\"/>\r\n                                                <div class=\"e-check row-fluid\" id=\"BankAccountType\">\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Bank Name<span class=\"field-required\">*</span></label>\r\n                                                        <input type=\"text\" id=\"an_bank_name\" value=\"\" class=\"input-large\"/>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Account Number<span class=\"field-required\">*</span></label>\r\n                                                        <input type=\"text\" id=\"an_account_number\" value=\"\" class=\"input-large\"/>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Name On Account<span class=\"field-required\">*</span></label>\r\n                                                        <input type=\"text\" id=\"an_name_on_account\" value=\"\" class=\"input-large\"/>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Routing Number<span class=\"field-required\">*</span></label>\r\n                                                        <input type=\"text\" id=\"an_routing_number\" value=\"\" class=\"input-large\"/>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Account Type<span class=\"field-required\">*</span></label>\r\n                                                        <select class=\"input-large\" id=\"an_account_type\">\r\n                                                            <option value=\"\">Select an Option</option>\r\n                                                            <option value=\"checking\">Checking</option>\r\n                                                            <option value=\"savings\">Savings</option>\r\n                                                            <option value=\"businessChecking\" selected>Business Checking</option>\r\n                                                        </select>\r\n                                                    </div>\r\n                                                    <div class=\"span12\">\r\n                                                        <label>Electronic Check Type<span class=\"field-required\">*</span></label>\r\n                                                        <select class=\"input-large\" id=\"an_e_check_type\">\r\n                                                            <option value=\"\">Select an Option</option>\r\n                                                            <option value=\"CCD\" selected>CCD</option>\r\n                                                            <option value=\"PPD\">PPD</option>\r\n                                                            <option value=\"TEL\">TEL</option>\r\n                                                            <option value=\"WEB\">WEB</option>\r\n                                                        </select>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div class=\"span12\">\r\n                                                <hr />\r\n                                                <button class=\"btn btn-success\" id=\"an-paid-btn\" type=\"button\">Pay</button>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            ";
            }
            echo "                        ";
        }
        echo "                    ";
    }
    echo "                    <!--Paid Area end-->\r\n\r\n                </div>\r\n                ";
}
echo "                <div class=\"clear\"></div>\r\n            </form>\r\n        </div>\r\n        <div class=\"clear\"></div>\r\n    </div>\r\n    <div class=\"clear\"></div>\r\n</div>\r\n<div class=\"clear\"></div>\r\n\r\n<!-- Modal -->\r\n<div class=\"modal fade modal-signature\" id=\"myModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\"\r\n     style=\"display: none; max-height: 560px\">\r\n    <div class=\"modal-dialog\" role=\"document\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span\r\n                        aria-hidden=\"true\">&times;</span></button>\r\n                <h4 class=\"modal-title\" id=\"myModalLabel\">Adopt Your Signature</h4>\r\n            </div>\r\n            <div class=\"modal-body\">\r\n                <form method=\"post\" action=\"\" class=\"sigPad\">\r\n                    <p>Confirm your name, initials, and signature</p>\r\n                    <!--<label for=\"name\">Print your name</label>-->\r\n                    <table>\r\n                        <tr>\r\n                            <td style=\"width: 60%\">Full Name</td>\r\n                            <td style=\"width:3%;\"></td>\r\n                            <td>Title</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><input type=\"text\" name=\"name\" id=\"fullname_txt\" class=\"name input-text\" style=\"width: 95%\" required=\"required\"\r\n                                       value=\"\" placeholder=\"Print your name\"><span class=\"mark-required\" style=\"color: red;vertical-align: top;white-space: normal;\">*</span> </td>\r\n                            <td></td>\r\n                            <td><input type=\"text\" name=\"title_signature\" value=\"\" class=\"input-text\" placeholder=\"Title\"></td>\r\n                        </tr>\r\n                    </table>\r\n\r\n                    <p class=\"typeItDesc\">Review your signature</p>\r\n                    <p class=\"drawItDesc\">Draw your signature</p>\r\n                    <ul class=\"nav nav-tabs signature-tab\" style=\"margin-top: 15px; margin-bottom: 0px\">\r\n                        <li class=\"active typeit-tab\"><a data-toggle=\"tab\" href=\"#typeSignature\">Review your signature</a></li>\r\n                        <li class=\"draw-tab\"><a data-toggle=\"tab\"  href=\"#drawSignature\">Draw your signature</a></li>\r\n                    </ul>\r\n\r\n                    <div class=\"tab-content\">\r\n                        <div id=\"typeSignature\" class=\"tab-pane fade in active\">\r\n                            <div id=\"signature_detail\"  >\r\n                                <div id=\"signature\">\r\n                                    <div class=\"border_fullname\">\r\n                                        <div >\r\n                                            <div class=\"signed_by\">&nbsp;<p style=\"font-weight: initial;display: inline; font-size: 15px;\">Signed by:</p></div>\r\n                                            <div id=\"fullname_sign\">&nbsp;</div>\r\n                                            <div id=\"date_sign\">Sign Date</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                            <img style='display:block; visibility: hidden; height: 0px;'  id='base64imageImg' src='' />\r\n\r\n                        </div>\r\n                        <div id=\"drawSignature\" class=\"tab-pane fade\">\r\n                            <button class=\"clearButton\" style=\"    float: right; margin: 0; background: white;\"><a href=\"#clear\">Clear</a></button>\r\n                            <div class=\"sig sigWrapper\">\r\n                                <canvas class=\"pad\" width=\"500\" height=\"180\"></canvas>\r\n                                <input type=\"hidden\" name=\"output\" class=\"output\">\r\n                            </div>\r\n<!--                            <canvas class=\"pad\" width=\"500\" height=\"180\"></canvas>-->\r\n<!--                            <input type=\"hidden\" name=\"output\" class=\"output\">-->\r\n                        </div>\r\n                    </div>\r\n                    <div style=\"border-top: 1px solid  #ccc; padding: 5px;\">\r\n                        <p>By clicking Create, I agree that the signature and initials will be the electronic representation of my signature and initials for all purposes when I (or my agent) use them on envelopes, including legally binding contracts - just the same as a pen-and-paper signature or initial.</p>\r\n                    </div>\r\n                    <!--<button type=\"submit\">I accept the terms of this agreement.</button>-->\r\n                </form>\r\n            </div>\r\n            <div class=\"modal-footer\">\r\n                <!--<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button>-->\r\n                <button type=\"button\" class=\"btn btn-warning btn-submit\" style=\"background: #ffc820; color: #333\">Accept and sign</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n<!--modal- summit-->\r\n<div id=\"modal-summited\" class=\"modal fade\" role=\"dialog\">\r\n    <div class=\"modal-dialog\">\r\n        <!-- Modal content-->\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n                <h4 class=\"modal-title\">Thank you</h4>\r\n            </div>\r\n            <div class=\"modal-body\" style=\"text-align: left;color: green;font-size: 18px !important;\">\r\n                <span>";
echo nl2br($transactionRecord->get("success_content")) != "" ? nl2br($transactionRecord->get("success_content")) : $success_content;
echo "</span>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n</div>\r\n\r\n<!--modal- customer comments-->\r\n<div class=\"modal fade modal-customer-comment\" id=\"modal-comments\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\"\r\n     style=\"display: none; max-height: 560px\">\r\n    <div class=\"modal-dialog\" role=\"document\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span\r\n                        aria-hidden=\"true\">&times;</span></button>\r\n                <h4 class=\"modal-title\" id=\"myModalLabel\">";
echo $transactionRecord->get("label_decline");
echo "</h4>\r\n            </div>\r\n            <div class=\"modal-body\">\r\n                <form method=\"post\" action=\"\" class=\"test\">\r\n                    <div style=\"padding: 5px;\">\r\n                        <p>";
echo nl2br($transactionRecord->get("decline_message"));
echo "</p>\r\n                    </div>\r\n                    <textarea name=\"customer_comment\"  rows=\"10\" style=\"    width: 96%; margin: 0 auto; padding: 10px\"></textarea>\r\n                    <!--<button type=\"submit\">I accept the terms of this agreement.</button>-->\r\n                </form>\r\n            </div>\r\n            <div class=\"modal-footer\">\r\n                <!--<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button>-->\r\n                <button type=\"button\" class=\"btn btn-warning btn-submit\" style=\"background: #ffc820; color: #333\">";
echo $transactionRecord->get("label_decline");
echo "</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<script type=\"text/javascript\" src=\"../../../resources/Connector.js\"></script>\r\n<script type=\"text/javascript\" src=\"js/uitypes.js\"></script>\r\n<script type=\"text/javascript\" src=\"js/index.js\"></script>\r\n\r\n<script type=\"text/javascript\">\r\n    \$(document).ready(function () {\r\n        var signTo = \$(\"#hfSignTo\").val();\r\n        signTo = signTo.toUpperCase();\r\n        var body = \$('body');\r\n        var homeLoader = body.loadingIndicator({\r\n            useImage: false,\r\n            showOnInit: false\r\n        }).data(\"loadingIndicator\");\r\n        homeLoader.show();\r\n\r\n        // Global\r\n        window.QuotingTool = {};\r\n        // Config\r\n        window.QuotingTool.config = {};\r\n        // model\r\n        window.QuotingTool.model = {};\r\n        // data\r\n        window.QuotingTool.data = {};\r\n        window.QuotingTool.data.idxValues = {};\r\n\r\n        var proposalDocument = \$('#web-view-document');\r\n        var frmProposal = \$('form[name=\"frm-proposal-content\"]');\r\n        var inAction = frmProposal.find('[name=\"_action\"]');\r\n        var inModule = frmProposal.find('[name=\"module\"]');\r\n        var inRecordId = frmProposal.find('[name=\"record_id\"]');\r\n        var inSignature = frmProposal.find('[name=\"signature\"]');\r\n        var inSignatureName = frmProposal.find('[name=\"signature_name\"]');\r\n        var initialsPrimary = frmProposal.find('[name=\"initials_primary\"]');\r\n        var inSeondarySignature = frmProposal.find('[name=\"secondary_signature\"]');\r\n        var inSeondarySignatureName = frmProposal.find('[name=\"secondary_signature_name\"]');\r\n        var initialsSecondary = frmProposal.find('[name=\"initials_secondary\"]');\r\n        var inSignatureDatetime = frmProposal.find('[name=\"signature_datetime\"]');\r\n\r\n        var title_signature_primary = frmProposal.find('[name=\"title_signature_primary\"]');\r\n        var title_signature_secondary = frmProposal.find('[name=\"title_signature_secondary\"]');\r\n        var is_draw_signature = frmProposal.find('[name=\"is_draw_signature\"]');\r\n\r\n        var inStatus = frmProposal.find('[name=\"status\"]');\r\n        var inSeondaryStatus = frmProposal.find('[name=\"seondary_status\"]');\r\n        var inStatusText = frmProposal.find('[name=\"status_text\"]');\r\n        var inContent = frmProposal.find('[name=\"content\"]');\r\n        var inBackground = frmProposal.find('[name=\"background\"]');\r\n        var inAttachments = frmProposal.find('[name=\"attachments\"]');\r\n        var inCustomMappingFields = frmProposal.find('[name=\"custom_mapping_fields\"]');\r\n\r\n        var formCreateNewRecord = frmProposal.find('[name=\"form_create_record\"]');\r\n\r\n        // Date format\r\n        var dateFormat = \$('#date_format');\r\n        var hourFormat = \$('#hour_format');\r\n        window.QuotingTool.config.date_format = dateFormat.val();\r\n        window.QuotingTool.config.time_format = hourFormat.val();\r\n\r\n        //\r\n        window.QuotingTool.model.module = inModule.val();\r\n        window.QuotingTool.model.record_id = inRecordId.val();\r\n        var valCustomMappingFields = inCustomMappingFields.val();\r\n        window.QuotingTool.model.custom_mapping_fields = (valCustomMappingFields) ? JSON.parse(valCustomMappingFields) : {};\r\n\r\n        // Init default action request\r\n        QuotingToolProposal.changeAction(QuotingToolProposal.ACTION_SUBMIT, inAction);\r\n        // Init document\r\n        var content = QuotingToolUtils.base64Decode(inContent.val());\r\n        // Prepare before append the content\r\n        content = QuotingToolProposal.interactiveTextfield(content);\r\n\r\n        //get authnet payment block\r\n        var an_payment_block = frmProposal.find('[name=\"an_payment_block\"]').val();\r\n        if(\$.trim(an_payment_block) == ''){\r\n            an_payment_block = '';\r\n        }else{\r\n            an_payment_block = QuotingToolUtils.base64Decode(an_payment_block);\r\n        }\r\n\r\n        QuotingToolProposal.initDocument(proposalDocument, content, an_payment_block);\r\n\r\n        // Config to show signature button on right panel\r\n        var signatureContainers = \$('.quoting_tool-widget-signature-container');\r\n        var secondarySignatureContainers = \$('.quoting_tool-widget-secondary_signature-container');\r\n        var btnSignature = \$('#pdf-sign');\r\n        var allowSignature = false;\r\n        btnSignature.hide();\r\n\r\n        if ((signatureContainers && signatureContainers.length > 0) ||\r\n            (secondarySignatureContainers && secondarySignatureContainers.length > 0)) {\r\n            allowSignature = true;\r\n            btnSignature.show();\r\n        }\r\n\r\n        var replaceSignatureButton = proposalDocument.find('[data-target=\"#myModal\"]');\r\n        if (replaceSignatureButton.length > 0) {\r\n            \$('[data-target=\"#myModal\"]').not(replaceSignatureButton).parent().hide();\r\n        }\r\n\r\n        // var after merge content\r\n        var request = QuotingToolUtils.queryString();\r\n        window.QuotingTool.model.id = request['record'];    // transaction id\r\n        var frmSignature = \$('.modal-signature');\r\n        var inName = frmSignature.find('[name=\"name\"]');\r\n        var initials_name = frmSignature.find('[name=\"initials_name\"]');\r\n        var title_signature = frmSignature.find('[name=\"title_signature\"]');\r\n        var inSeondaryName = frmSignature.find('[name=\"secondary_name\"]');\r\n        var inOutput = frmSignature.find('[name=\"output\"]');\r\n        var proposalContents = \$('.proposal-doc');   // With multi pages\r\n        var signatureModal = \$('#myModal');\r\n//        var datepickers = \$('.quoting_tool-datetimepicker');\r\n        var hashtagContainer = \$('#quoting_tool-sidebar-hashtag');\r\n        var attachmentsContainer = \$('#quoting_tool-sidebar-attachment');\r\n        var frmCreateRelatedRecord = frmProposal.find('[data-table-type=\"create_related_record\"]');\r\n\r\n        // Signature pad\r\n        var sigPad = \$('#drawSignature').signaturePad({\r\n            lineTop: 114,\r\n            lineWidth: 1,\r\n            drawOnly: true,\r\n            bgColour: 'transparent'\r\n        });\r\n\r\n        var valSignature = inSignature.val();\r\n        var valSignatureName = inSignatureName.val();\r\n        var valInitialsName = initialsPrimary.val();\r\n        var valTitleSignaturePrimary = title_signature_primary.val();\r\n        var valIsDrawSignature = is_draw_signature.val();\r\n\r\n\r\n        var valSeondarySignature = inSeondarySignature.val();\r\n        var valSeondarySignatureName = inSeondarySignatureName.val();\r\n        var valSeondaryInitialsName = initialsSecondary.val();\r\n        var valTitleSignatureSecond = title_signature_secondary.val();\r\n\r\n        var valSignatureDatetime = inSignatureDatetime.val();\r\n        // Init default name\r\n        if (signTo == 'SECONDARY'){\r\n            inName.val(valSeondarySignatureName);\r\n            initials_name.val(valSeondaryInitialsName);\r\n            title_signature.val(valTitleSignatureSecond);\r\n        } else {\r\n            inName.val(valSignatureName);\r\n            initials_name.val(valInitialsName);\r\n            title_signature.val(valTitleSignaturePrimary);\r\n        }\r\n        inSeondaryName.val(valSeondarySignatureName);\r\n\r\n        // Init signature\r\n        var dSignature = [];\r\n        if (valSignature) {\r\n            if(valIsDrawSignature == 'yes' && (signTo ==''|| signTo =='PRIMARY')) {\r\n                var dSignature = \$('<div/>').html(valSignature).text();\r\n                dSignature = JSON.parse(dSignature);\r\n                sigPad.regenerate(dSignature);\r\n//                var signatureImage = sigPad.getSignatureImage();\r\n//                QuotingToolProposal.addDateSigned(valSignatureDatetime);\r\n                //QuotingToolProposal.updateCurrentDatetime(datepickers, new Date(valSignatureDatetime));\r\n                // Update signature & resize this box\r\n//                QuotingToolProposal.updateSignature(signatureContainers, valSignatureName, signatureImage);\r\n//                QuotingToolProposal.resizeSignatureBox(signatureContainers);\r\n            }\r\n        }\r\n        if (valSeondarySignature && signTo == 'SECONDARY') {\r\n            if (valIsDrawSignature == 'yes') {\r\n                var dSeondarySignature = \$('<div/>').html(valSeondarySignature).text();\r\n                dSeondarySignature = JSON.parse(dSeondarySignature);\r\n                sigPad.regenerate(dSeondarySignature);\r\n//                var seondarySignatureImage = sigPad.getSignatureImage();\r\n                //QuotingToolProposal.updateCurrentDatetime(datepickers, new Date(valSignatureDatetime));\r\n//                QuotingToolProposal.addDateSigned(valSignatureDatetime);\r\n                // Update signature & resize this box\r\n//                QuotingToolProposal.updateSignature(secondarySignatureContainers, valSeondarySignatureName, seondarySignatureImage);\r\n//                QuotingToolProposal.resizeSignatureBox(secondarySignatureContainers);\r\n                if (signTo != 'SECONDARY') {\r\n                    sigPad.regenerate(dSignature);\r\n                }\r\n            }\r\n        } else {\r\n            if (signTo == 'SECONDARY'){\r\n                sigPad.regenerate([]);\r\n            }\r\n        }\r\n        if(valSignatureName != '' || valSeondarySignatureName != '') {\r\n            var fullName = '';\r\n            var title = '';\r\n            if(signTo == 'SECONDARY') {\r\n                fullName = valSeondarySignatureName;\r\n                title = valTitleSignatureSecond;\r\n            }else{\r\n                fullName = valSignatureName;\r\n                title = valTitleSignaturePrimary;\r\n            }\r\n//            var title = (valTitleSignaturePrimary != '') ? valTitleSignaturePrimary : valTitleSignatureSecond;\r\n//            var fullName = (valSignatureName != '') ? valSignatureName : valSeondarySignatureName;\r\n            if(title != '') {\r\n                title = ' (' + title + ')';\r\n            }\r\n            frmSignature.find('.signed_by').html('&nbsp;<p style=\"font-weight: initial;display: inline; font-size: 15px;\">Signed by: </p>' + fullName + title);\r\n            \$('#fullname_sign').html(fullName);\r\n        }\r\n\r\n        // Init status\r\n        QuotingToolProposal.initStatus(inStatus.val());\r\n        // Set document background\r\n        QuotingToolProposal.initBackground(body, inBackground.val());\r\n        // Init hash tag (index headings)\r\n        QuotingToolProposal.initHashtags(hashtagContainer, proposalContents, 'h1');\r\n        // Init attachments\r\n        var valAttachments = inAttachments.val();\r\n        if (valAttachments) {\r\n            QuotingToolProposal.initAttachments(attachmentsContainer, JSON.parse(valAttachments));\r\n        }\r\n        \$(\"[required='required']\").on('keyup', function () {\r\n            var focus = \$(this);\r\n            if(focus.val() != '') {\r\n                focus.css('border-color', '#ccc');\r\n            }else{\r\n                focus.css('border-color', '#e9322d');\r\n            }\r\n        });\r\n        \$(\"[name='datepicker']\").on('change', function () {\r\n            var focus = \$(this);\r\n            if(focus.val() != '') {\r\n                focus.css('border-color', '#ccc');\r\n            }\r\n        });\r\n\r\n\r\n        // Submit proposal\r\n        \$('.action').on('click', function (event) {\r\n            event.preventDefault();\r\n            var focusInstance = \$(this);\r\n            var isDecline = false;\r\n            if(focusInstance.hasClass('action-decline')) {\r\n                isDecline = true;\r\n            }\r\n            var required = \$(\"[required='required']\");\r\n            \$.each(required, function (idx, elm) {\r\n                if(\$(elm).val() == '') {\r\n                    \$(elm).css('border-color', '#e9322d');\r\n                }\r\n            });\r\n            var checkboxField = \$('input[type=\"checkbox\"]');\r\n            var unSubmit = false;\r\n            var requireCreateRelatedRecord = true;\r\n            if(frmCreateRelatedRecord.length == 0) {\r\n                requireCreateRelatedRecord = false;\r\n            }\r\n            var signature = \$(\".quoting_tool-widget-signature-container, .quoting_tool-widget-secondary_signature-container\");\r\n            if(!isDecline) {\r\n                \$.each(signature, function (key, val) {\r\n                    var parentSignature = \$(val);\r\n                    if(( (signTo == 'PRIMARY' || signTo =='') && parentSignature.hasClass('quoting_tool-widget-signature-container') )\r\n                        ||   signTo == 'SECONDARY' && parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                        var signatureIndex = parentSignature.find('img').attr('src');\r\n                        if(signatureIndex != '' && signatureIndex != undefined ){\r\n                            if(signatureIndex.indexOf('SignHere3') > 0 || signatureIndex.indexOf('secondary-signature') > 0) {\r\n                                alert('Please sign the document completely.');\r\n                                requireCreateRelatedRecord = true;\r\n                                return false;\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n                \$.each(frmCreateRelatedRecord, function (idx, val) {\r\n                    var focus = \$(val);\r\n                    var dataTable = focus.data('info');\r\n                    if(dataTable) {\r\n                        var require = dataTable['require_data'];\r\n                        var labelRelatedModule = dataTable['related_module_label'];\r\n                        if(require == true) {\r\n                            var row1 = focus.find('tr[data-row-number=\"1\"]');\r\n                            \$.each(dataTable['settings']['item_fields'], function (key, field) {\r\n                                var fieldValue = \$(row1[1]).find('[name^='+field['name']+']').val();\r\n                                if(fieldValue !='') {\r\n                                    requireCreateRelatedRecord = false;\r\n                                    return false;\r\n                                }\r\n                            });\r\n                            if(requireCreateRelatedRecord == true) {\r\n                                alert('Please add at least one row in the '+labelRelatedModule+' section');\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n\r\n                //valid Authrozie Profile fields\r\n                if(\$('.an-payment-block-container', frmProposal).length > 0) {\r\n                    if(QuotingToolProposal.validANPaymentBlock(frmProposal)===false){\r\n                        return false;\r\n                    }else{\r\n                        // Get values in the first\r\n                        var params = {\r\n                            type: 'POST',\r\n                            url: 'ValidateCard.php',\r\n                            dataType: 'json',\r\n                            data: frmProposal.serialize()\r\n                        };\r\n\r\n                        AppConnector.request(params).then(\r\n                            function (response) {\r\n                                if (!response.success) {\r\n                                    alert(response.error.message);\r\n                                    requireCreateRelatedRecord = true;\r\n                                    // Hide signature modal\r\n                                    signatureModal.modal('hide');\r\n                                    return false;\r\n                                }\r\n                                homeLoader.hide();\r\n                            },\r\n                            function (error) {\r\n                                console.log('error =', error);\r\n                            });\r\n\r\n                    }\r\n                }\r\n\r\n                \$.each(checkboxField, function (idx, val) {\r\n                    var focus = \$(this);\r\n                    var preInput = focus.prev();\r\n                    if(\$(preInput).val() == 'No'){\r\n                        focus.focus();\r\n                        unSubmit = true;\r\n                        return false;\r\n                    }\r\n                });\r\n                if (!frmProposal.isValid2() || unSubmit == true) {\r\n                    alert('Please fill out all the mandatory field before submitting the form.');\r\n                    return false;\r\n                }\r\n                if(requireCreateRelatedRecord == true) {\r\n                    return false;\r\n                }\r\n                //valid Authrozie Profile fields\r\n                if(\$('.an-payment-block-container', frmProposal).length > 0) {\r\n                    if(QuotingToolProposal.validANPaymentBlock(frmProposal)===false){\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n\r\n            var focus = \$(this);\r\n            if (allowSignature && !inSignature.val() && !focus.hasClass('action-decline')) {\r\n//                var sign = confirm('Do you want to sign this document?');\r\n//                if (sign == true) {\r\n                \$('[data-target]').click();\r\n                    return false;\r\n//                }\r\n            }\r\n            //Decline - Dont require signature\r\n            if((inSeondarySignatureName.val() == '' && signTo == 'SECONDARY' && allowSignature && !focus.hasClass('action-decline')) || inSignatureName.val() ==''&& allowSignature && !focus.hasClass('action-decline')){\r\n                \$('[data-target]').click();\r\n                return false;\r\n            }\r\n\r\n\r\n            // Show loader indicator\r\n            homeLoader.show();\r\n\r\n            // Change action\r\n            QuotingToolProposal.changeAction(QuotingToolProposal.ACTION_SUBMIT, inAction);\r\n\r\n            var status = 0;\r\n            if ((focusInstance.hasClass('action-accept') && focusInstance.hasClass('inactive')) || formCreateNewRecord.val() == 'true') {\r\n                status = 1;\r\n            } else if (focusInstance.hasClass('action-decline') && focusInstance.hasClass('inactive')) {\r\n                status = -1;\r\n            }\r\n            inStatus.val(status);\r\n            inStatusText.val(focusInstance.find('.proposal-btn').text().trim());\r\n            // Refresh content input\r\n            proposalContents = \$('.proposal-doc').clone();\r\n            proposalContents = QuotingToolProposal.revertInteractiveTextfield(proposalContents);\r\n            var proposalContentsHtml = QuotingToolProposal.extractDocument(proposalContents);\r\n            inContent.val(QuotingToolUtils.base64Encode(proposalContentsHtml));\r\n            // Custom mapping fields\r\n            inCustomMappingFields.val(JSON.stringify(window.QuotingTool.model.custom_mapping_fields));\r\n            if(\$('#enable_decline_mess').val() == \"true\" && focusInstance.hasClass('action-decline')) {\r\n                var modalComment = \$(\"#modal-comments\");\r\n                modalComment.modal();\r\n                homeLoader.hide();\r\n                modalComment.on('click', '.btn-submit', function (event) {\r\n                    event.preventDefault();\r\n                    homeLoader.show();\r\n                    var customerComment = modalComment.find('[name=\"customer_comment\"]').val();\r\n                    frmProposal.find('[name=\"customer_comment\"]').text(customerComment);\r\n                    // Get values in the first\r\n                    var actionParams = {\r\n                        type: 'POST',\r\n                        url: 'action.php',\r\n                        dataType: 'json',\r\n                        data: frmProposal.serialize()\r\n                    };\r\n\r\n                    AppConnector.request(actionParams).then(\r\n                        function (response) {\r\n                            if (response.success) {\r\n                                homeLoader.hide();\r\n                                var parent = focusInstance.closest('.actions');\r\n                                parent.find('.action').not(focusInstance).addClass('inactive');\r\n                                focusInstance.toggleClass('inactive');\r\n                                modalComment.modal('hide');\r\n                                \$(\"#modal-summited\").modal()\r\n                            } else {\r\n                                alert('error');\r\n                            }\r\n\r\n                        },\r\n                        function (error) {\r\n                            console.log('error =', error);\r\n                        });\r\n\r\n                });\r\n                return false;\r\n\r\n            }\r\n\r\n\r\n            // Get values in the first\r\n            var actionParams = {\r\n                type: 'POST',\r\n                url: 'action.php',\r\n                dataType: 'json',\r\n                data: frmProposal.serialize()\r\n            };\r\n\r\n            AppConnector.request(actionParams).then(\r\n                function (response) {\r\n                    if (response.success) {\r\n                        var parent = focusInstance.closest('.actions');\r\n                        parent.find('.action').not(focusInstance).addClass('inactive');\r\n                        focusInstance.toggleClass('inactive');\r\n                        \$(\"#modal-summited\").modal()\r\n                    } else {\r\n                        alert('error');\r\n                    }\r\n\r\n                    homeLoader.hide();\r\n                },\r\n                function (error) {\r\n                    console.log('error =', error);\r\n                });\r\n        });\r\n\r\n        \$('[data-target]').click(function () {\r\n            var thisFocus = \$(this);\r\n\r\n            if (!frmProposal.isValid2()) {\r\n                alert('Please fill out all the mandatory field before submitting the form.');\r\n                return false;\r\n            }\r\n\r\n            //valid Authrozie Profile fields\r\n            if(\$('.an-payment-block-container', frmProposal).length > 0) {\r\n                if(QuotingToolProposal.validANPaymentBlock(frmProposal)===false){\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            var scrollPos = document.documentElement.scrollTop;\r\n            var targetModal = thisFocus.data('target');\r\n            var modal = \$(targetModal);\r\n            modal.modal('show');\r\n            setTimeout(function () {\r\n                var btnClose = modal.find('[data-dismiss=\"modal\"]');\r\n                if (btnClose.length > 0) {\r\n                    \$(btnClose[0]).focus();\r\n                }\r\n                var dt = new Date();\r\n               var valSignatureDateTime = formatDate(dt);\r\n                \$('#date_sign').html(valSignatureDateTime);\r\n                var fullname_txt = \$('#fullname_txt').val();\r\n                var initials_txt = \$('#initials_txt').val();\r\n                var signatureCode = inOutput.val();\r\n                if(fullname_txt != '' && (signatureCode == ''|| signatureCode == '[]')) {\r\n                    \$('#fullname_sign').text(fullname_txt);\r\n                    \$('#initials_sign').text(initials_txt);\r\n                    html2canvas(jQuery(document).contents().find('#signature_detail'), {\r\n                        onrendered: function(canvas) {\r\n                            var thumbnail = canvas.toDataURL('image/png', 1);\r\n                            jQuery(\"#base64imageImg\").attr('src', thumbnail);\r\n                            window.scrollTo(0,scrollPos);\r\n                        },\r\n                    });\r\n                }\r\n            }, 500);\r\n        });\r\n        function formatDate(date) {\r\n            var hours = date.getHours();\r\n            var minutes = date.getMinutes();\r\n            var format = \$('#date_format').val();\r\n            var time_format = \$('#hour_format').val();\r\n            var ampm = '';\r\n            if(time_format == '12'){\r\n                ampm = hours >= 12 ? 'pm' : 'am';\r\n                hours = hours % 12;\r\n                hours = hours ? hours : 12; // the hour '0' should be '12'\r\n            }\r\n            minutes = minutes < 10 ? '0'+minutes : minutes;\r\n            var strTime = hours + ':' + minutes + ' ' + ampm;\r\n            var valSignatureDate = AppHelper.formatDate(format, date);\r\n            return valSignatureDate + \"  \" + strTime;\r\n        }\r\n\r\n        // Sign and submit proposal\r\n        frmSignature.on('click', '.btn-submit', function (event) {\r\n            event.preventDefault();\r\n            var indexImageSignature = \$('[name=\"signature_image_index\"]').val();\r\n            if(indexImageSignature == ''){\r\n                indexImageSignature = \"signatureImageIndex1\"\r\n            }\r\n            if (!\$('.sigPad').isValid2()) {\r\n                alert('Please fill out all the mandatory field before submitting the form.');\r\n                if(\$('#fullname_txt').val() == '') {\r\n                    \$('#fullname_txt').focus();\r\n                }\r\n                return false;\r\n            }else{\r\n                var signatureCode = inOutput.val();\r\n                var signatureImage = '';\r\n                var signatureName = inName.val();\r\n                var initialsName = initials_name.val();\r\n                var titleSignature = title_signature.val();\r\n                var base64imageImg = \$('#base64imageImg').attr('src');\r\n                if(signatureCode != '[]' && signatureCode != '') {\r\n                    signatureImage = sigPad.getSignatureImage();\r\n                    var cloneSignature =  \$(frmSignature.find('#typeSignature')).clone();\r\n                    var imgDraw = '<img src=\"'+signatureImage+'\" style=\"width: 200px; height: 50px\">';\r\n                    \$(cloneSignature.find('#fullname_sign')).html(imgDraw);\r\n                    cloneSignature.find('#signature_detail').addClass('signature-clone');\r\n                    cloneSignature.find('#signature_detail').css(\"height\", \"80px\");\r\n                    cloneSignature.find('#signature_detail').css(\"width\", \"400px\");\r\n                    cloneSignature.find('#signature').css('padding-top', '10px');\r\n                    cloneSignature.find('#date_sign').css({'margin-top': '-7px', 'font-size': '15px'});\r\n                    cloneSignature.find('.signed_by').css({'margin-top': '-7px','font-size': '15px'});\r\n                    cloneSignature.find('.signed_by').find('p').css({'font-size': '15px'});\r\n                    cloneSignature.find('#fullname_sign').css({'margin-bottom' : '10px', 'height' : '30px','line-height' : '17px', \"font-size\": \"36px\"});\r\n                    \$(document).find('body').append(cloneSignature.html());\r\n                    html2canvas(jQuery(document).contents().find('.signature-clone'), {\r\n                        onrendered: function(canvas) {\r\n                            var thumbnail = canvas.toDataURL('image/png', 1.0);\r\n                            signatureImage = thumbnail;\r\n                            inSignature.val(thumbnail);\r\n                            if (signTo == 'SECONDARY'){\r\n                                if(indexImageSignature != '') {\r\n                                    secondarySignatureContainers = \$('[data-image-index=\"' + indexImageSignature + '\"]').closest('.quoting_tool-draggable-object');\r\n                                    QuotingToolProposal.updateSignature(secondarySignatureContainers, signatureName, signatureImage);\r\n                                    QuotingToolProposal.resizeSignatureBox(secondarySignatureContainers);\r\n                                }\r\n                            } else {\r\n                                if(indexImageSignature != '') {\r\n                                    signatureContainers = \$('[data-image-index=\"' + indexImageSignature + '\"]').closest('.quoting_tool-draggable-object');\r\n                                    QuotingToolProposal.updateSignature(signatureContainers, signatureName, signatureImage);\r\n                                    QuotingToolProposal.resizeSignatureBox(signatureContainers);\r\n                                }\r\n                            }\r\n                            \$(document).find('body').find('.signature-clone').remove();\r\n                        }\r\n                    });\r\n                    is_draw_signature.val('yes');\r\n//                \$('#fullname_txt').val('');\r\n//                \$('#initials_txt').val('');\r\n//                \$('#fullname_sign').html('&nbsp;');\r\n//                \$('#initials_sign').html('&nbsp;');\r\n                }else{\r\n                    is_draw_signature.val('no');\r\n                    var cloneSignature =  \$(frmSignature.find('#typeSignature')).clone();\r\n                    cloneSignature.find('#signature_detail').addClass('signature-clone');\r\n                    cloneSignature.find('#signature_detail').css(\"height\", \"80px\");\r\n                    cloneSignature.find('#signature_detail').css(\"width\", \"400px\");\r\n                    cloneSignature.find('#signature').css('padding-top', '10px');\r\n                    cloneSignature.find('#date_sign').css({'margin-top': '-7px', 'font-size': '15px'});\r\n                    cloneSignature.find('.signed_by').css({'margin-top': '-7px','font-size': '15px'});\r\n                    cloneSignature.find('.signed_by').find('p').css({'font-size': '15px'});\r\n                    cloneSignature.find('#fullname_sign').css({'margin-bottom' : '10px', 'height' : '30px','line-height' : '17px', \"font-size\": \"36px\"});\r\n                    \$(document).find('body').append(cloneSignature.html());\r\n                    var scrollPos = document.documentElement.scrollTop;\r\n                    setTimeout(function () {\r\n                        html2canvas(jQuery(document).contents().find('.signature-clone'), {\r\n                            onrendered: function(canvas) {\r\n                                var thumbnail = canvas.toDataURL('image/png', 1.0);\r\n                                signatureImage = thumbnail;\r\n                                inSignature.val(thumbnail);\r\n                                window.scrollTo(0,scrollPos);\r\n                                if (signTo == 'SECONDARY'){\r\n                                    if(indexImageSignature != '') {\r\n                                        secondarySignatureContainers = \$('[data-image-index=\"' + indexImageSignature + '\"]').closest('.quoting_tool-draggable-object');\r\n                                        QuotingToolProposal.updateSignature(secondarySignatureContainers, signatureName, signatureImage);\r\n                                        QuotingToolProposal.resizeSignatureBox(secondarySignatureContainers);\r\n                                    }\r\n                                } else {\r\n                                    if(indexImageSignature != '') {\r\n                                        signatureContainers = \$('[data-image-index=\"' + indexImageSignature + '\"]').closest('.quoting_tool-draggable-object');\r\n                                        QuotingToolProposal.updateSignature(signatureContainers, signatureName, signatureImage);\r\n                                        QuotingToolProposal.resizeSignatureBox(signatureContainers);\r\n                                    }\r\n                                }\r\n                                \$(document).find('body').find('.signature-clone').remove();\r\n                            }\r\n                        });\r\n                    },500);\r\n\r\n                }\r\n                var format = \$('#date_format').val();\r\n                //var signed_date = AppHelper.formatDate(format,new Date());\r\n                var datepickers = \$(\"[name='date_signed']\");\r\n                if(datepickers.length != 0) {\r\n                    QuotingToolProposal.addDateSigned();\r\n                }\r\n\r\n//                // Update signature to form\r\n//                if(signatureCode != '[]' && signatureCode != '') {\r\n//                    inSignature.val(signatureCode);\r\n////                signatureName = '';\r\n////                initialsName = '';\r\n//                }else{\r\n//                    inSignature.val(base64imageImg);\r\n//                }\r\n                inSignatureName.val(signatureName);\r\n                initialsPrimary.val(initialsName);\r\n                if(signTo == 'SECONDARY'){\r\n                    inSeondarySignatureName.val(signatureName);\r\n                    initialsSecondary.val(initialsName);\r\n                }\r\n                title_signature_primary.val(titleSignature);\r\n                // Hide signature modal\r\n                signatureModal.modal('hide');\r\n                //update signature-here\r\n                \$('.signature-here').remove();\r\n                setTimeout(function () {\r\n                    var signature = \$(\".quoting_tool-widget-signature-container, .quoting_tool-widget-secondary_signature-container\");\r\n                    \$.each(signature, function (key, val) {\r\n                        var parentSignature = \$(val);\r\n                        if(( (signTo == 'PRIMARY' || signTo =='') && parentSignature.hasClass('quoting_tool-widget-signature-container') )\r\n                            ||   signTo == 'SECONDARY' && parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                            var positionSignature = \$(parentSignature).offset().top - 30;\r\n                            var signatureImg = parentSignature.find('img');\r\n                            var signatureIndex = signatureImg.data('image-index');\r\n                            var srcSignatureImg = signatureImg.attr('src');\r\n                            if(signatureIndex != undefined && signatureIndex != '' && srcSignatureImg != undefined && srcSignatureImg != '') {\r\n                                if(signatureIndex != indexImageSignature && (srcSignatureImg.indexOf('SignHere3') > 0 || srcSignatureImg.indexOf('secondary-signature') > 0)) {\r\n                                    \$(document).find('#quoting_tool-body').append('<img src=\"../../../modules/QuotingTool/proposal/images/SignHere.png\" class=\"signature-here\" style=\"height: 40px; width: 120px; position: absolute; left: -120px; top: '+positionSignature+'px\">')\r\n                                    parentSignature.append();\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                    });\r\n                }, 200);\r\n//                setTimeout(function () {\r\n//                    // Click to submit\r\n//                    \$('.action.action-accept').trigger('click');\r\n//                }, 500);\r\n                return false;\r\n            }\r\n        });\r\n\r\n        // Download PDF\r\n        \$('#pdf-download').on('click', function () {\r\n            if (frmProposal.isValid2()) {\r\n                // Change action\r\n                QuotingToolProposal.changeAction(QuotingToolProposal.ACTION_DOWNLOAD_PDF, inAction);\r\n                // Refresh content input\r\n                proposalContents = \$('.proposal-doc').clone();\r\n                proposalContents = QuotingToolProposal.revertInteractiveTextfield(proposalContents);\r\n                var proposalContentsHtml = QuotingToolProposal.extractDocument(proposalContents);\r\n                inContent.val(QuotingToolUtils.base64Encode(proposalContentsHtml));\r\n                frmProposal.submit();\r\n            } else {\r\n                alert('Invalid proposal');\r\n            }\r\n        });\r\n\r\n        // Trigger to update value\r\n        frmProposal.on('change', ':input', function () {\r\n            var thisFocus = \$(this);\r\n            var input = thisFocus;\r\n            var inputValue = input.val();\r\n            var type = input[0].type;\r\n            var mappingVal = inputValue;\r\n            var virtualInfo = thisFocus.data('info');\r\n            if (!virtualInfo) {\r\n                virtualInfo = {};\r\n            }\r\n            if(type == 'textarea') {\r\n                var contentTextarea = thisFocus.val();\r\n            }\r\n            switch (type) {\r\n                case 'checkbox':\r\n                    if (input.hasClass('interactive_form_item')) {\r\n                        if (input.prop('checked')) {\r\n                            input.attr('checked', 'checked');\r\n                        } else {\r\n                            input.removeAttr('checked');\r\n                        }\r\n                    } else {\r\n                        var dataVirtualField = thisFocus.data('virtual-field');\r\n                        var isVirtualField = (dataVirtualField) ? dataVirtualField : false;\r\n\r\n                        if (isVirtualField) {\r\n                            input = thisFocus.prev('.interactive_form_item');\r\n                        }\r\n\r\n                        var isChecked = thisFocus.prop('checked');\r\n                        mappingVal = (isChecked) ? 1 : 0;\r\n                        if (isChecked) {\r\n//                        input.attr('checked', 'checked');\r\n//                        input.val(inputValue);\r\n//                        input.attr('value', inputValue);\r\n                        } else {\r\n//                        input.removeAttr('checked');\r\n                        }\r\n                        inputValue = (isChecked && virtualInfo['values']) ? virtualInfo['values']['true'] : virtualInfo['values']['false'];\r\n                        input.val(inputValue);\r\n                        input.attr('value', inputValue);\r\n                    }\r\n\r\n                    break;\r\n                case 'text':\r\n                    input.attr('value', input.val());\r\n                    break;\r\n                case 'textarea':\r\n                    input.text(contentTextarea);\r\n                    break;\r\n                case 'select-one':\r\n//                    input = thisFocus.siblings('.interactive_form_item');\r\n//                    inputValue = thisFocus.val();\r\n//                    input.val(inputValue);\r\n//                    input.attr('value', inputValue);\r\n//                    break;\r\n                case 'select-multiple':\r\n                    input = thisFocus.siblings('.interactive_form_item');\r\n                    inputValue = thisFocus.val();\r\n                    if (type == 'select-multiple' && inputValue) {\r\n                        mappingVal = inputValue.join(' |##| ');\r\n                        inputValue = inputValue.join(', ');\r\n                    }\r\n                    input.val(inputValue);\r\n                    input.attr('value', inputValue);\r\n                    break;\r\n                default:\r\n                    break;\r\n            }\r\n\r\n            var info = \$(input).data('info');\r\n            if (!info) {\r\n                info = {};\r\n            }\r\n            var fieldId = info['id'];\r\n\r\n            if (window.QuotingTool.model.custom_mapping_fields[window.QuotingTool.model.record_id]\r\n                && window.QuotingTool.model.custom_mapping_fields[window.QuotingTool.model.record_id][fieldId]) {\r\n                window.QuotingTool.model.custom_mapping_fields[window.QuotingTool.model.record_id][fieldId]['value'] = mappingVal;\r\n//                inCustomMappingFields.val(JSON.stringify(window.QuotingTool.model.custom_mapping_fields));\r\n            }\r\n        });\r\n\r\n        // Toggle sidebar\r\n        \$('#sidebar').on('click', '[data-toggle=\"collapse\"]', function () {\r\n            \$(this).parent().find(\"i.indicator\")\r\n                .toggleClass('icon-chevron-down icon-chevron-up');\r\n        });\r\n\r\n        // Datepicker:\r\n        \$('.quoting_tool-datepicker').each(function () {\r\n            var thisFocus = \$(this);\r\n            var info = thisFocus.data('info');\r\n            if(info){\r\n                var date_format = info.date_format;\r\n\r\n                if (info.current_timestamp) {\r\n                    // Default is current timestamp\r\n                    var timestamp = new Date();\r\n                    var currentDate = AppHelper.formatDate(date_format, timestamp);\r\n                    thisFocus.attr({\r\n                        'value': currentDate\r\n                    });\r\n                }\r\n\r\n                if (info.editable) {\r\n                    thisFocus.datepicker({\r\n                        format: date_format,\r\n                        autoclose: true\r\n                    });\r\n//                app.registerEventForDateFields();\r\n                }\r\n            }\r\n        });\r\n\r\n        \$('.ui-timepicker-input').each(function () {\r\n            var thisFocus = \$(this);\r\n            var info = thisFocus.data('info');\r\n\r\n            if (info.editable) {\r\n                app.registerEventForTimeFields();\r\n            }\r\n        });\r\n\r\n        \$('.select2').select2();\r\n\r\n        // Smooth scroll\r\n        // Add smooth scrolling to all links\r\n        \$(\"#quoting_tool-sidebar-hashtag a\").on('click', function(event) {\r\n\r\n            // Make sure this.hash has a value before overriding default behavior\r\n            if (this.hash !== \"\") {\r\n                // Prevent default anchor click behavior\r\n                event.preventDefault();\r\n\r\n                // Store hash\r\n                var hash = this.hash;\r\n\r\n                // Using jQuery's animate() method to add smooth page scroll\r\n                // The optional number (800) specifies the number of milliseconds it takes to scroll to the specified area\r\n                \$('html, body').animate({\r\n                    scrollTop: \$(hash).offset().top\r\n                }, 800, function(){\r\n\r\n                    // Add hash (#) to URL when done scrolling (default click behavior)\r\n                    window.location.hash = hash;\r\n                });\r\n            } // End if\r\n        });\r\n\r\n        //Payment block\r\n        if(\$('.an-payment-block-container', frmProposal).length > 0){\r\n            var anPaymentBlockContainer = \$('.an-payment-block-container', frmProposal);\r\n            //show echeck type depend on bank account type\r\n            \$('[name=an_payment_block_account_type]', anPaymentBlockContainer).on('change', function (event) {\r\n                event.preventDefault();\r\n                var element = \$(this);\r\n                var bank_account_type = element.val();\r\n                if(bank_account_type==''){\r\n                    \$('[name=an_payment_block_e_check_type] option', anPaymentBlockContainer).each(function(){\r\n                        if(\$(this).val()!==''){\r\n                            \$(this).attr('disabled', true);\r\n                        }\r\n                    });\r\n                    \$('[name=an_payment_block_e_check_type]', anPaymentBlockContainer).select2('val', '');\r\n                }else if(bank_account_type=='businessChecking'){\r\n                    \$('[name=an_payment_block_e_check_type] option', anPaymentBlockContainer).each(function(){\r\n                        if(\$(this).val()!=='CCD'){\r\n                            \$(this).attr('disabled', true);\r\n                        }else{\r\n                            \$(this).removeAttr('disabled');\r\n                        }\r\n                    });\r\n                    \$('[name=an_payment_block_e_check_type]', anPaymentBlockContainer).select2('val', '');\r\n                }else{\r\n                    \$('[name=an_payment_block_e_check_type] option', anPaymentBlockContainer).each(function(){\r\n                        if(\$(this).val()=='CCD'){\r\n                            \$(this).attr('disabled', true);\r\n                        }else{\r\n                            \$(this).removeAttr('disabled');\r\n                        }\r\n                    });\r\n                    \$('[name=an_payment_block_e_check_type]', anPaymentBlockContainer).select2('val', '');\r\n                }\r\n            });\r\n\r\n            //register display fields of payment method event\r\n            \$('[name=an_payment_block_payment_method]', anPaymentBlockContainer).on('change', function(event){\r\n                event.preventDefault();\r\n                var element = \$(this);\r\n                var payment_method = element.val();\r\n                if(payment_method=='CreditCardSimpleType'){\r\n                    //show credit card block\r\n                    anPaymentBlockContainer.find('[name=an_payment_block_card_number]').closest('div.fieldBlockContainer').show();\r\n                    //hide bank account block\r\n                    anPaymentBlockContainer.find('[name=an_payment_block_bank_name]').closest('div.fieldBlockContainer').hide();\r\n                }else if(payment_method=='BankAccountType'){\r\n                    //hide credit card block\r\n                    anPaymentBlockContainer.find('[name=an_payment_block_card_number]').closest('div.fieldBlockContainer').hide();\r\n                    //show bank account block\r\n                    anPaymentBlockContainer.find('[name=an_payment_block_bank_name]').closest('div.fieldBlockContainer').show();\r\n                }else{\r\n                    //hide credit card block\r\n                    anPaymentBlockContainer.find('[name=an_payment_block_card_number]').closest('div.fieldBlockContainer').hide();\r\n                    //hide bank account block\r\n                    anPaymentBlockContainer.find('[name=an_payment_block_bank_name]').closest('div.fieldBlockContainer').hide();\r\n                }\r\n            });\r\n            //register expiration date value\r\n            \$('#an_payment_block_expiration_month_alias, #an_payment_block_expiration_year_alias', anPaymentBlockContainer).on('change', function(event){\r\n                event.preventDefault();\r\n                var expiration_value = '';\r\n                var month = \$('#an_payment_block_expiration_month_alias', anPaymentBlockContainer).val();\r\n                var year = \$('#an_payment_block_expiration_year_alias', anPaymentBlockContainer).val();\r\n                var current_month = \$('#an_payment_block_current_month', anPaymentBlockContainer).val();\r\n                var current_year = \$('#an_payment_block_current_year', anPaymentBlockContainer).val();\r\n                if(month != '00' && year != '0000' && ((current_year==year && parseInt(month)>=parseInt(current_month)) || year>current_year)){\r\n                    expiration_value = year + '-' + month + '-' + '15';\r\n                }\r\n                if(expiration_value=='' && month != '00' && year != '0000'){\r\n                    alert('Expired date must greater than current time');\r\n                }\r\n                \$('[name=an_payment_block_expiration_date]', anPaymentBlockContainer).val(expiration_value);\r\n            });\r\n        }\r\n\r\n        \$('.input-text').on('keyup', function () {\r\n            var fullname_txt = \$('#fullname_txt').val();\r\n            var initials_txt = \$('#initials_txt').val();\r\n            var title_signature = \$('[name=\"title_signature\"]').val();\r\n            if(fullname_txt == '') {\r\n                fullname_txt ='&nbsp;';\r\n            }\r\n\r\n            if(initials_txt == '') {\r\n                initials_txt ='&nbsp;';\r\n            }\r\n            var signed_by = \$('.signed_by');\r\n            if(title_signature != '') {\r\n                title_signature = ' (' + title_signature + ')';\r\n            }\r\n            signed_by.html('&nbsp;<p style=\"font-weight: initial;display: inline; font-size: 15px;\">Signed by: </p> ' + fullname_txt + title_signature);\r\n            \$('#fullname_sign').html(fullname_txt);\r\n            \$('#initials_sign').html(initials_txt);\r\n            var scrollPos = document.documentElement.scrollTop;\r\n            html2canvas(jQuery(document).contents().find('#signature_detail'), {\r\n                onrendered: function(canvas) {\r\n                    var thumbnail = canvas.toDataURL('image/png', 1.0);\r\n                    jQuery(\"#base64imageImg\").attr('src', thumbnail);\r\n                    window.scrollTo(0,scrollPos);\r\n                },\r\n            });\r\n//            \$('.clearButton').trigger('click');\r\n        });\r\n        // Delay to hide progress indicator\r\n        setTimeout(function () {\r\n            homeLoader.hide();\r\n        }, 2000);\r\n\r\n        setTimeout(function () {\r\n            // add cursor signature\r\n            var signature = \$(\".quoting_tool-widget-signature-container, .quoting_tool-widget-secondary_signature-container\");\r\n            \$.each(signature, function (key, val) {\r\n                var parentSignature = \$(val);\r\n                if(signTo == 'SECONDARY' && valSignatureName == '') {\r\n                    if(parentSignature.hasClass('quoting_tool-widget-signature-container')) {\r\n                        parentSignature.hide();\r\n                        return;\r\n                    }\r\n                }else if((signTo == '' || signTo == 'PRIMARY') && valSeondarySignatureName == '') {\r\n                    if(parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                        parentSignature.hide();\r\n                        return;\r\n                    }\r\n                }\r\n                if(( (signTo == 'PRIMARY' || signTo =='') && parentSignature.hasClass('quoting_tool-widget-signature-container') )\r\n                    ||   signTo == 'SECONDARY' && parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                    var positionSignature = \$(parentSignature).offset().top - 30;\r\n                    var signatureIndex = parentSignature.find('img').attr('src');\r\n                    if(signatureIndex != '' && signatureIndex != undefined ){\r\n                        if(signatureIndex.indexOf('SignHere3') > 0 || signatureIndex.indexOf('secondary-signature') > 0) {\r\n                            \$(document).find('#quoting_tool-body').append('<img src=\"../../../modules/QuotingTool/proposal/images/SignHere.png\" class=\"signature-here\" style=\"height: 40px; width: 120px; position: absolute; left: -120px; top: ' + positionSignature + 'px\">')\r\n                            parentSignature.append();\r\n                        }\r\n                    }\r\n                }\r\n\r\n            });\r\n        }, 1000);\r\n\r\n        //registerevent click to signature\r\n        var top_url = window.location.href;\r\n        var convertUrlToDataParams =  function (url) {\r\n            var params = {};\r\n            if (typeof url !== 'undefined' && url.indexOf('?') !== -1) {\r\n                var urlSplit = url.split('?');\r\n                url = urlSplit[1];\r\n            }\r\n            var queryParameters = url.split('&');\r\n            for (var index = 0; index < queryParameters.length; index++) {\r\n                var queryParam = queryParameters[index];\r\n                var queryParamComponents = queryParam.split('=');\r\n                params[queryParamComponents[0]] = queryParamComponents[1];\r\n            }\r\n            return params;\r\n        };\r\n        var params = convertUrlToDataParams(top_url);\r\n        if(params['preview']!=true) {\r\n            \$('.quoting_tool-widget-signature-image,.quoting_tool-widget-secondary_signature-image').on('click', function () {\r\n                var focus = \$(this);\r\n                var imageIndex = focus.data('image-index');\r\n                if (signTo == 'SECONDARY' && focus.hasClass('quoting_tool-widget-secondary_signature-image') || (signTo == '' || signTo == 'PRIMARY') && focus.hasClass('quoting_tool-widget-signature-image')) {\r\n                    var srcImage = focus.attr('src');\r\n                    if (srcImage.indexOf('SignHere3') > 0 || srcImage.indexOf('secondary-signature') > 0) {\r\n                        if (signTo == '' || signTo == 'PRIMARY') {\r\n                            \$.each(\$('.quoting_tool-widget-signature-image'), function (idx, value) {\r\n                                var srcFocus = \$(value).attr('src');\r\n                                if (srcFocus.indexOf('SignHere3') == -1) {\r\n                                    focus.attr('src', srcFocus);\r\n                                    focus.css({'height': '80px', 'width': '400px'});\r\n\r\n                                    \$('.signature-here').remove();\r\n                                    setTimeout(function () {\r\n                                        var signature = \$(\".quoting_tool-widget-signature-container, .quoting_tool-widget-secondary_signature-container\");\r\n                                        \$.each(signature, function (key, val) {\r\n                                            var parentSignature = \$(val);\r\n                                            if (((signTo == 'PRIMARY' || signTo == '') && parentSignature.hasClass('quoting_tool-widget-signature-container'))\r\n                                                || signTo == 'SECONDARY' && parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                                                var positionSignature = \$(parentSignature).offset().top - 30;\r\n                                                var signatureIndex = parentSignature.find('img').attr('src');\r\n                                                if(signatureIndex != '' && signatureIndex != undefined ){\r\n                                                    if(signatureIndex.indexOf('SignHere3') > 0 || signatureIndex.indexOf('secondary-signature') > 0) {\r\n                                                        \$(document).find('#quoting_tool-body').append('<img src=\"../../../modules/QuotingTool/proposal/images/SignHere.png\" class=\"signature-here\" style=\"height: 40px; width: 120px; position: absolute; left: -120px; top: ' + positionSignature + 'px\">')\r\n                                                        parentSignature.append();\r\n                                                    }\r\n                                                }\r\n\r\n                                            }\r\n\r\n                                        });\r\n                                    }, 100);\r\n                                    return false;\r\n                                } else {\r\n                                    \$('[data-target]').trigger('click');\r\n                                    \$('[name=\"signature_image_index\"]').val(imageIndex);\r\n                                }\r\n                            });\r\n                        }\r\n                        if (signTo == 'SECONDARY') {\r\n                            \$.each(\$('.quoting_tool-widget-secondary_signature-image'), function (idx, value) {\r\n                                var srcFocus = \$(value).attr('src');\r\n                                if (srcFocus.indexOf('secondary-signature') == -1) {\r\n                                    focus.attr('src', srcFocus);\r\n                                    focus.css({'height': '80px', 'width': '400px'});\r\n\r\n                                    \$('.signature-here').remove();\r\n                                    setTimeout(function () {\r\n                                        var signature = \$(\".quoting_tool-widget-signature-container, .quoting_tool-widget-secondary_signature-container\");\r\n                                        \$.each(signature, function (key, val) {\r\n                                            var parentSignature = \$(val);\r\n                                            if (((signTo == 'PRIMARY' || signTo == '') && parentSignature.hasClass('quoting_tool-widget-signature-container'))\r\n                                                || signTo == 'SECONDARY' && parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                                                var positionSignature = \$(parentSignature).offset().top - 30;\r\n                                                var signatureIndex = parentSignature.find('img').attr('src');\r\n                                                if(signatureIndex != '' && signatureIndex != undefined ){\r\n                                                    if(signatureIndex.indexOf('SignHere3') > 0 || signatureIndex.indexOf('secondary-signature') > 0) {\r\n                                                        \$(document).find('#quoting_tool-body').append('<img src=\"../../../modules/QuotingTool/proposal/images/SignHere.png\" class=\"signature-here\" style=\"height: 40px; width: 120px; position: absolute; left: -120px; top: ' + positionSignature + 'px\">')\r\n                                                        parentSignature.append();\r\n                                                    }\r\n                                                }\r\n                                            }\r\n\r\n                                        });\r\n                                    }, 100);\r\n                                    return false;\r\n                                } else {\r\n                                    \$('[data-target]').trigger('click');\r\n                                    \$('[name=\"signature_image_index\"]').val(imageIndex);\r\n                                }\r\n                            });\r\n                        }\r\n                    } else {\r\n                        \$('[data-target]').trigger('click');\r\n                        \$('[name=\"signature_image_index\"]').val(imageIndex);\r\n                    }\r\n\r\n                }\r\n            });\r\n        }\r\n        //change page layout\r\n        var page_width=\$('input#page_width').val();\r\n        var page_margin=\$('input#page_margin').val();\r\n        var content_width=\$('input#content_width').val();\r\n        var page_dpi=\$('#check_dpi').height();\r\n        page_width=page_width*page_dpi/72;\r\n        content_width=content_width*page_dpi/72;\r\n\r\n        if(page_margin!='' && page_width!=''){\r\n            \$('.proposal-doc').css({\r\n                'width': page_width+'px',\r\n                'padding':page_margin\r\n            })\r\n            \$('#content').css({\r\n                'width': content_width+'px'\r\n            })\r\n            \$('#viewport').css({\r\n                'width':content_width+400+'px'\r\n            })\r\n        }\r\n\r\n        \$(window).on(\"beforeunload\", function() {\r\n            var signature = \$(\".quoting_tool-widget-signature-container, .quoting_tool-widget-secondary_signature-container\");\r\n            var isSignedAll = false;\r\n            \$.each(signature, function (key, val) {\r\n                var parentSignature = \$(val);\r\n                if(( (signTo == 'PRIMARY' || signTo =='') && parentSignature.hasClass('quoting_tool-widget-signature-container') )\r\n                    ||   signTo == 'SECONDARY' && parentSignature.hasClass('quoting_tool-widget-secondary_signature-container')) {\r\n                    var signatureIndex = parentSignature.find('img').attr('src');\r\n                    if(signatureIndex != '' && signatureIndex != undefined ){\r\n                        if(signatureIndex.indexOf('SignHere3') > 0 || signatureIndex.indexOf('secondary-signature') > 0) {\r\n                            isSignedAll = true;\r\n                            return false;\r\n                        }else{\r\n                            isSignedAll = false;\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n            var status = \$('[name=\"status\"]').val();\r\n            if(isSignedAll == false && status == 0 && params['preview']!=\"true\") {\r\n                return 'Are you sure you want to leave?';\r\n            }\r\n        });\r\n    });\r\n//addButton\r\n    \$(document).ready(function () {\r\n        var thisInstance=this;\r\n        var relatedRecordTable=\$('table[data-table-type=\"create_related_record\"]');\r\n        var parentDiv=relatedRecordTable.parent('div');\r\n        var divFirst=parentDiv.parent('div');\r\n        divFirst.css('height','');\r\n\r\n        //clear value\r\n        relatedRecordTable.find('input').each(function () {\r\n            \$(this).val('');\r\n        });\r\n        //clear value select 2\r\n        relatedRecordTable.find('select.select2').each(function () {\r\n            var thisInstance=this;\r\n            \$(thisInstance).attr('name',\$(thisInstance).parent('td').find('input.multipicklist').attr('name'));\r\n            \$(thisInstance).parent('td').find('input.multipicklist').attr('class','hide');\r\n            \$(thisInstance).val('');\r\n        });\r\n\r\n        if(\$('#addRecord').length<1){\r\n            parentDiv.append('<a class=\"button btn\" id=\"addRecord\">Add Record</a>');\r\n        }\r\n        var baseRow=relatedRecordTable.find('tr.hide');\r\n        var select2value=function () {\r\n            relatedRecordTable.find('select.select2').each(function () {\r\n                if(\$(this).parent('td').find('input').val()){\r\n                    \$(this).val(\$(this).parent('td').find('input').val());\r\n                    \$(this).attr('value',\$(this).parent('td').find('input').val());\r\n                }\r\n            })\r\n        };\r\n        var getdatepicker=function () {\r\n            \$('tr:last').find('.date').find('input').datepicker();\r\n        };\r\n        var registerCheckboxValue=function () {\r\n            relatedRecordTable.find('tbody').find('tr:last').find('input[type=\"checkbox\"]').change(function () {\r\n                if(\$(this).is(':checked')){\r\n                    \$(this).closest('td').find('input:first').val('1');\r\n                    \$(this).closest('td').find('input:first').attr('value','1');\r\n                }\r\n                else{\r\n                    \$(this).closest('td').find('input:first').val('0');\r\n                    \$(this).closest('td').find('input:first').attr('value','0');\r\n                }\r\n            })\r\n        };\r\n        registerCheckboxValue();\r\n        var orderSelectOption=function () {\r\n            var defaultValue='Select an Option';\r\n            relatedRecordTable.find('tbody').find('tr:last').find('select.select2').each(function () {\r\n                var thisInstance=this;\r\n                \$(this).find('option').each(function () {\r\n                    if(\$(this).attr('value')==defaultValue){\r\n                        \$(this).remove();\r\n                        \$(thisInstance).prepend('<option selected=\"selected\" value=\"'+defaultValue+'\">'+defaultValue+'</option>')\r\n                    }\r\n                })\r\n            });\r\n        };\r\n        orderSelectOption();\r\n        relatedRecordTable.find('tbody').find('tr:last').find('select.select2').each(function () {\r\n            if(\$(this).attr('multiple')){\r\n               return;\r\n            }\r\n            \$(this).find('option:first').attr('value','');\r\n            \$(this).closest('td').find('div.select2-container').find('span:first').html( \$(this).find('option:first').html());\r\n            \$(this).find('option:first').prop('selected',true);\r\n            \$(this).find('option:first').attr('selected','selected');\r\n        });\r\n        var mutilpicklist=function () {\r\n            relatedRecordTable.find('select.select2').change(function () {\r\n                \$(this).closest('td').children('input').attr('value',\$(this).val());\r\n            })\r\n        };\r\n        var setCssSelect2=function () {\r\n            relatedRecordTable.find('select.select2').each(function () {\r\n                \$(this).closest('td').find('div.select2-container').css('width','150px');\r\n            })\r\n        };\r\n        relatedRecordTable.find('tr:last').append('<td class=\"hide\"><textarea name=\"data-fields\">'+relatedRecordTable.attr('data-info')+'</textarea></td>');\r\n        \$('#addRecord').click(function () {\r\n            relatedRecordTable.find('tbody').append('<tr>'+baseRow.html()+'</tr>');\r\n            relatedRecordTable.find('input[name=\"data-fields\"]:last').parent('td').remove();\r\n            relatedRecordTable.find('tbody').find('tr:last').find('div.select2').remove();\r\n            relatedRecordTable.find('tbody').find('tr:last').find('select').select2();\r\n            // QuotingToolProposal.registerEvent(relatedRecordTable);\r\n            relatedRecordTable.find('.date').each(function () {\r\n                \$(this).find('input').datepicker();\r\n            });\r\n            orderSelectOption();\r\n            relatedRecordTable.find('tbody').find('tr:last').find('select.select2').each(function () {\r\n                if(\$(this).attr('multiple')){\r\n                    return;\r\n                }\r\n                \$(this).find('option:first').attr('value','');\r\n                \$(this).closest('td').find('div.select2-container').find('span:first').html( \$(this).find('option:first').html());\r\n                \$(this).find('option:first').prop('selected',true);\r\n                \$(this).find('option:first').attr('selected','selected');\r\n            });\r\n            // \$('select.select2:last').find('option:first').prop('selected',true);\r\n            registerCheckboxValue();\r\n            getdatepicker();\r\n            mutilpicklist();\r\n            setCssSelect2();\r\n        });\r\n\r\n        mutilpicklist();\r\n        select2value();\r\n        setCssSelect2();\r\n    });\r\n\r\n</script>\r\n</body>\r\n</html>";
function get_client_ip()
{
    $ipaddress = "";
    if (getenv("HTTP_CLIENT_IP")) {
        $ipaddress = getenv("HTTP_CLIENT_IP");
    } else {
        if (getenv("HTTP_X_FORWARDED_FOR")) {
            $ipaddress = getenv("HTTP_X_FORWARDED_FOR");
        } else {
            if (getenv("HTTP_X_FORWARDED")) {
                $ipaddress = getenv("HTTP_X_FORWARDED");
            } else {
                if (getenv("HTTP_FORWARDED_FOR")) {
                    $ipaddress = getenv("HTTP_FORWARDED_FOR");
                } else {
                    if (getenv("HTTP_FORWARDED")) {
                        $ipaddress = getenv("HTTP_FORWARDED");
                    } else {
                        if (getenv("REMOTE_ADDR")) {
                            $ipaddress = getenv("REMOTE_ADDR");
                        } else {
                            $ipaddress = "UNKNOWN";
                        }
                    }
                }
            }
        }
    }
    return $ipaddress;
}

?>